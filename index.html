<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Farm2Earn ‚Äî Play</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#06060a; --card:#0f1114; --muted:#9aa3b2; --gold:#f6c94b;
  --accent:#7ef2b3; --glass: rgba(255,255,255,0.03);
  --success:#4caf50; --error:#ff6b6b;
}
*{box-sizing:border-box}
body{margin:0; font-family:Inter,system-ui,Arial; background:
  radial-gradient(800px 400px at 10% 10%, rgba(246,201,75,0.04), transparent),
  linear-gradient(180deg,#05050a,#0b0b0d); color:#e9eef8; -webkit-font-smoothing:antialiased}
.app{max-width:1100px;margin:28px auto;padding:18px}
header{display:flex;gap:12px;align-items:center;justify-content:space-between}
.brand{display:flex;gap:12px;align-items:center}
.logo{width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,var(--gold),#ffd86b);display:flex;align-items:center;justify-content:center;color:#111;font-weight:800;font-size:20px;box-shadow:0 8px 30px rgba(246,201,75,0.08)}
h1{margin:0;font-size:18px}
.top-stats{display:flex;gap:10px;align-items:center}
.stat{background:var(--card);padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.02);font-size:13px}
.actions{display:flex;gap:8px;align-items:center}
.btn{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px 12px;border-radius:10px;color:inherit;cursor:pointer}
.btn.gold{background:linear-gradient(90deg,var(--gold),#ffd86b);color:#111;font-weight:700}
.btn.primary{background:linear-gradient(90deg,#7ef2b3,#42d3a2);color:#022; font-weight:700}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:18px;margin-top:22px}
.card{background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);padding:16px;border-radius:14px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 10px 30px rgba(0,0,0,0.6)}
.crop-title{display:flex;align-items:center;gap:12px}
.emoji{font-size:28px}
.small{font-size:13px;color:var(--muted)}
.controls{margin-top:12px;display:flex;gap:8px;align-items:center}
input, select{width:100%;padding:10px;border-radius:8px;border:none;background:#0b0b0f;color:#eaf0ff}
.full{grid-column: span 3}
.footer{margin-top:22px;text-align:center;color:var(--muted);font-size:13px}
.history-list{max-height:260px;overflow:auto;margin-top:12px;border-radius:10px;padding:8px;background:rgba(255,255,255,0.015)}
table{width:100%;border-collapse:collapse;color:#dbe9f7}
th,td{padding:8px;text-align:left;border-bottom:1px dashed rgba(255,255,255,0.03);font-size:13px}
.overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,2,2,0.6);z-index:100}
.popup{width:420px;background:linear-gradient(180deg,#0b0b0d,#0e1114);padding:18px;border-radius:12px;border:1px solid rgba(246,201,75,0.06);box-shadow:0 20px 60px rgba(0,0,0,0.7);text-align:center;position:relative}
.progress{height:12px;background:rgba(255,255,255,0.03);border-radius:8px;overflow:hidden;margin-top:10px}
.progress > i{display:block;height:100%;width:0%;background:linear-gradient(90deg,var(--gold),#ffd86b)}
.qr{display:flex;gap:12px;align-items:center;justify-content:center;margin-top:12px}
.row{display:flex;gap:8px;align-items:center}
@media(max-width:980px){ .grid{grid-template-columns:1fr} .full{grid-column:span 1} .logo{display:none} header{flex-direction:column;align-items:flex-start;gap:8px} }

/* card re-style */
.card{ background:#111; padding:15px; border-radius:12px; color:#fff; margin:10px 0; display:flex; flex-direction:column; gap:10px; }
.controls input{ width:60px; padding:8px; border-radius:6px; border:none; background:#222; color:#fff; }
.btn{ padding:8px 12px; border:none; border-radius:8px; cursor:pointer; font-weight:700; transition:0.18s; }
.btn.gold{ background:var(--gold); color:#000; }
.btn.gold:hover{ filter:brightness(.95); }
.btn.primary{ background:linear-gradient(90deg,#7ef2b3,#42d3a2); color:#022; }
.popup-content{ text-align:left; color:#eaf0ff; }
.popup-close{ position:absolute; right:12px; top:8px; cursor:pointer; color:#fff; font-weight:700; }
.msgBox {
  position: fixed;
  top: -60px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(30, 30, 30, 0.95);
  color: #fff;
  padding: 12px 20px;
  border-radius: 12px;
  font-size: 14px;
  font-weight: 500;
  box-shadow: 0 0 10px rgba(0,0,0,0.4);
  opacity: 0;
  transition: all 0.45s ease;
  z-index: 9999;
}
.msgBox.show {
  top: 25px;
  opacity: 1;
}
.msgBox.success { background: linear-gradient(135deg,#3cd65b,#128d3b); color:#fff; }
.msgBox.error { background: linear-gradient(135deg,#ff5555,#c92a2a); color:#fff; }
.msgBox.info { background: linear-gradient(135deg,#f8d47e,#b89734); color:#111; }
/* === SUCCESS TICK ANIMATION === */
.successTick {
  width: 70px;
  height: 70px;
  border-radius: 50%;
  border: 4px solid #2ecc71;
  display: flex;
  justify-content: center;
  align-items: center;
  margin: 0 auto 10px auto;
  animation: pop 0.3s ease-out forwards;
}

.successTick svg {
  width: 38px;
  height: 38px;
  stroke: #2ecc71;
  stroke-width: 4;
  fill: none;
  stroke-dasharray: 50;
  stroke-dashoffset: 50;
  animation: draw 0.5s ease forwards 0.3s;
}

@keyframes pop {
  0% { transform: scale(0); opacity: 0; }
  80% { transform: scale(1.1); opacity: 1; }
  100% { transform: scale(1); opacity: 1; }
}

@keyframes draw {
  to { stroke-dashoffset: 0; }
}

/* streak bar override color */
.progress > i.streak { background: linear-gradient(90deg,#7ef2b3,#42d3a2); height:100%; display:block; }
.profileBox{
  background:#0e0f14;
  padding:18px;
  border:1px solid rgba(255,255,255,0.06);
  border-radius:14px;
  margin-top:15px;
  box-shadow:0 0 18px rgba(255,215,0,0.05);
}

.heading{
  margin:0 0 12px;
  color:#f6c94b;
  font-size:20px;
  text-align:center;
  font-weight:700;
}

.label{
  display:block;
  margin-top:10px;
  font-size:13px;
  color:#c8cbd1;
}

.in{
  width:100%;
  padding:11px;
  border-radius:10px;
  border:none;
  background:#12131a;
  color:white;
  margin-top:4px;
  font-size:14px;
  outline:none;
  border:1px solid rgba(255,255,255,0.08);
}

.in:focus{
  border:1px solid #f6c94b;
  background:#16171f;
}

.line{
  height:1px;
  width:100%;
  background:rgba(255,255,255,0.05);
  margin:14px 0;
}
/* üå± Seed drop animation */
.seed {
  position: fixed;
  top: -30px;
  font-size: 24px;
  pointer-events: none;
  animation: fall 1.2s ease-out forwards, bounce 0.4s ease-out 1s forwards;
  z-index: 9999;
}

@keyframes fall {
  0% { transform: translateY(-30px) scale(1); opacity: 1; }
  90% { opacity: 1; }
  100% { transform: translateY(120vh) scale(1.2); opacity: 0.8; }
}

@keyframes bounce {
  0% { transform: translateY(120vh) scale(1); }
  50% { transform: translateY(118vh) scale(1.1); }
  100% { transform: translateY(120vh) scale(1); }
}
/* =====================================================
   FRUIT TRADING STYLE (Farm2Earn Theme Style)
======================================================*/

#fruit {
  background:#0e0f14;
  padding:18px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,0.05);
  box-shadow:0 0 25px rgba(255,215,0,0.05);
}

#fruit h3 {
  font-size:20px;
  margin-bottom:10px;
  color:var(--gold);
  font-weight:700;
  text-align:center;
}

/* Timer */
#fruitTimer {
  font-size:22px;
  color:#7ef2b3;
  font-weight:700;
}

#fruitPeriod {
  color:#ffd86b;
  font-weight:700;
}

/* Fruit Buttons */
#fruit button.btn.primary {
  font-size:17px;
  background:linear-gradient(135deg, #121418, #171a20);
  color:#fff;
  border:1px solid rgba(255,255,255,0.04);
  border-radius:12px;
  padding:12px 10px;
  transition:0.22s;
  font-weight:700;
  box-shadow:0 0 12px rgba(255,255,255,0.03);
}

#fruit button.btn.primary:hover {
  transform:scale(1.04);
  background:linear-gradient(135deg,#1a1d24,#20242c);
}

/* Bet amount buttons */
#fruit .btn {
  background:#11151a;
  border:1px solid rgba(255,255,255,0.06);
  padding:10px 16px;
  border-radius:10px;
  color:#e9eef8;
  font-weight:600;
  transition:0.2s;
}

#fruit .btn:hover {
  background:#171b22;
  border-color:rgba(255,215,0,0.2);
}

/* Selected Bet amount highlight */
.betSelected {
  background:linear-gradient(90deg,#ffd86b,#f6c94b) !important;
  color:#111 !important;
  box-shadow:0 0 12px rgba(246,201,75,0.25);
}

/* Result text */
#fruitResult {
  margin-top:15px;
  padding:10px;
  background:#101319;
  border-radius:12px;
  border:1px solid rgba(255,255,255,0.04);
  font-size:17px;
  text-align:center;
}

/* History Table */
#fruitHistory {
  width:100%;
  border-collapse:collapse;
  color:#e9eef8;
  font-size:14px;
}

#fruitHistory th {
  background:#11151a;
  padding:10px;
  color:#ffd86b;
  font-weight:700;
  border-bottom:1px solid rgba(255,255,255,0.06);
}

#fruitHistory td {
  padding:10px;
  border-bottom:1px dashed rgba(255,255,255,0.04);
}

#fruitHistory tr:hover {
  background:#151921;
  transition:0.2s;
}
#countdownPopup {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.65);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 99999;
  backdrop-filter: blur(3px);
}

.cd-box {
  background: linear-gradient(180deg,#1b1b1e,#0f0f11);
  padding: 30px 40px;
  border-radius: 18px;
  text-align: center;
  border: 1px solid rgba(246,201,75,0.3);
  box-shadow: 0 0 45px rgba(246,201,75,0.25);
  animation: cdPop 0.35s ease-out;
}

@keyframes cdPop {
  0% { transform: scale(0.6); opacity: 0; }
  100% { transform: scale(1); opacity: 1; }
}

#cd-number {
  font-size: 72px;
  font-weight: 800;
  color: #ffd86b;
  text-shadow: 0 0 20px rgba(246,201,75,0.8);
}

.cd-text {
  margin-top: 8px;
  font-size: 17px;
  color: #ddd;
}


@keyframes glow {
  0% { text-shadow: 0 0 8px rgba(246,201,75,0.4); }
  100% { text-shadow: 0 0 20px rgba(246,201,75,0.9); }
}

@keyframes popIn {
  0% { transform: scale(0.5); opacity: 0; }
  100% { transform: scale(1); opacity: 1; }
}

</style>
 <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
</head>
<body>

<div class="app">
  <header>
  <div class="brand">
    <div class="logo" style="background:none;box-shadow:none;padding:0">
      <img src="logo.png" style="width:48px;height:48px;border-radius:10px;object-fit:cover;">
    </div>

    <div>
      <h1>Farm2Earn ‚Äî Play</h1>
    </div>
  </div>

  <div class="top-stats">
    <div class="stat">UID: <b id="meId">‚Äî</b></div>
    <div class="stat">Balance: <b id="meBal">‚Çπ0</b></div>
    <div class="stat">Coins: <b id="meCoins">0</b></div>
    <div class="stat">Farms: <b id="meFarms">0</b></div>
    <div class="actions">
      <button class="btn" onclick="fullRefresh()">Refresh</button>
      <button class="btn" id="openAdminHint" title="Admin (hidden)" style="display:none">Admin</button>
    </div>
  </div>
</header>


  <nav style="margin-top:12px">
    <button class="btn" onclick="show('farm')">Farm</button>
    <button class="btn" onclick="show('fruit')">Fruzo</button>
    <button class="btn" onclick="show('wallet')">Wallet</button>
    <button class="btn" onclick="show('profile')">Profile</button>
    <button class="btn gold" onclick="show('history')">History</button>
  </nav>
<div id="noticePopup" style="
  position:fixed;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  background:rgba(0,0,0,0.55);
  backdrop-filter:blur(6px);
  z-index:99999;
  opacity:0;
  transition:opacity 0.5s ease;
">

  <div id="popupBox" style="
    background:rgba(20,20,26,0.85);
    padding:26px;
    width:300px;
    border-radius:16px;
    border:2px solid rgba(246,201,75,0.4);
    box-shadow:0 0 25px rgba(246,201,75,0.25);
    text-align:center;
    opacity:0;
    transform:scale(0.6) translateY(30px);
    transition:all 0.55s cubic-bezier(0.16, 1, 0.3, 1);
    position:relative;
  ">

      <!-- Glowing animated border -->
      <div class="glowRing"></div>

      <!-- Countdown ring -->
      <div class="ringContainer">
          <svg class="ringSvg">
              <circle class="ringBg" cx="40" cy="40" r="36"></circle>
              <circle class="ringProg" cx="40" cy="40" r="36"></circle>
          </svg>
          <div class="ringText" id="popupTimer">3</div>
      </div>

      <div id="npText" style="font-size:17px;color:#fff;margin-top:14px;"></div>
      <div id="npTime" style="font-size:13px;color:#c9c9c9;margin-top:6px;"></div>

  </div>
</div>

<style>
/* Animated golden border glow */
.glowRing {
  position:absolute;
  inset:-2px;
  border-radius:16px;
  border:2px solid transparent;
  animation:glow 2s infinite linear;
}
@keyframes glow {
  0% { box-shadow:0 0 10px rgba(246,201,75,0.4); }
  50% { box-shadow:0 0 22px rgba(246,201,75,0.7); }
  100% { box-shadow:0 0 10px rgba(246,201,75,0.4); }
}

/* Countdown Circle */
.ringContainer {
  width:80px;
  height:80px;
  margin:0 auto;
  position:relative;
}
.ringSvg {
  width:80px;
  height:80px;
}
.ringBg {
  fill:none;
  stroke:#333;
  stroke-width:6;
}
.ringProg {
  fill:none;
  stroke:#f6c94b;
  stroke-width:6;
  stroke-linecap:round;
  stroke-dasharray:226;
  stroke-dashoffset:0;
  transition:stroke-dashoffset 1s linear;
}
.ringText {
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:22px;
  font-weight:700;
  color:#ffd86b;
  text-shadow:0 0 8px rgba(246,201,75,0.8);
}
</style>




  <div id="farm" class="grid">
    <div class="card">
      <div class="crop-title">
        <div class="emoji">üçÖ</div>
        <div>
          <div style="font-weight:700;color:var(--gold)">Tomato ‚Äî Lot (20)</div>
          <div class="small">Cost/lot: ‚Çπ200 ‚Ä¢ Time: 5m</div>
        </div>
      </div>
      <div class="controls">
        <input id="tomatoLots" type="number" min="1" value="1">
        <button class="btn gold" onclick="openFarmPopup('tomato')">Start</button>
      </div>
    </div>

    <div class="card">
      <div class="crop-title">
        <div class="emoji">ü•ï</div>
        <div>
          <div style="font-weight:700;color:var(--gold)">Carrot ‚Äî Lot (15)</div>
          <div class="small">Cost/lot: ‚Çπ150 ‚Ä¢ Time: 5m</div>
        </div>
      </div>
      <div class="controls">
        <input id="carrotLots" type="number" min="1" value="1">
        <button class="btn gold" onclick="openFarmPopup('carrot')">Start</button>
      </div>
    </div>

    <div class="card">
      <div class="crop-title">
        <div class="emoji">ü•î</div>
        <div>
          <div style="font-weight:700;color:var(--gold)">Potato ‚Äî Lot (25)</div>
          <div class="small">Cost/lot: ‚Çπ250 ‚Ä¢ Time: 5m</div>
        </div>
      </div>
      <div class="controls">
        <input id="potatoLots" type="number" min="1" value="1">
        <button class="btn gold" onclick="openFarmPopup('potato')">Start</button>
      </div>
    </div>

    <div class="card full">
      <h3 style="margin:0;color:var(--gold)">Quick Actions</h3>
      <div class="small" style="margin-top:8px">Quick farm, deposit or check history.</div>
      <div style="margin-top:10px" class="row">
        <button class="btn primary" onclick="quickFarm50()">Quick Farm ‚Çπ50</button>
      </div>
    </div>
  </div>
  <!-- FRUIT TRADING GAME -->
<div id="fruit" class="card full" style="display:none;margin-top:18px">

<h3 style="color:var(--gold)">Fruzo</h3>

<!-- Timer -->
<div style="margin-top:8px;font-size:16px">
  Period: <b id="fruitPeriod">-</b><br>
  Time Left: <b id="fruitTimer">2:00</b>
</div>

<!-- Fruits -->
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:18px;">
  <button class="btn primary fruitBtn" onclick="chooseFruit('apple', this)">üçé Apple</button>
  <button class="btn primary fruitBtn" onclick="chooseFruit('avocado', this)">ü•ë Avocado</button>
  <button class="btn primary fruitBtn" onclick="chooseFruit('banana', this)">üçå Banana</button>
  <button class="btn primary fruitBtn" onclick="chooseFruit('grapes', this)">üçá Grapes</button>
  <button class="btn primary fruitBtn" onclick="chooseFruit('orange', this)">üçä Orange</button>
  <button class="btn primary fruitBtn" onclick="chooseFruit('mango', this)">ü•≠ Mango</button>
</div>

<h4 style="color:var(--gold);margin-top:15px">Bet Quantity</h4>
<div style="display:flex;gap:10px;margin-top:10px;">
    <button class="btn qtyBtn" onclick="chooseQty(1, this)">√ó1</button>
    <button class="btn qtyBtn" onclick="chooseQty(2, this)">√ó2</button>
    <button class="btn qtyBtn" onclick="chooseQty(5, this)">√ó5</button>
    <button class="btn qtyBtn" onclick="chooseQty(10, this)">√ó10</button>

</div>

<!-- Bets Amount -->
<h4 style="color:var(--gold);margin-top:15px">Select Bet Amount</h4>
<div style="display:flex;gap:10px;margin-top:10px;">
    <button class="btn amtBtn" onclick="chooseAmount(10, this)">‚Çπ10</button>
    <button class="btn amtBtn" onclick="chooseAmount(50, this)">‚Çπ50</button>
    <button class="btn amtBtn" onclick="chooseAmount(100, this)">‚Çπ100</button>
    <button class="btn amtBtn" onclick="chooseAmount(500, this)">‚Çπ500</button>

</div>
<button class="btn gold" onclick="confirmFruitBet()" style="margin-top:15px;width:100%">
  Confirm Bet
</button>
<div id="countdownPopup" style="display:none;">
  <div class="cd-box">
      <div id="cd-number">10</div>
      <div class="cd-text">Result Generating‚Ä¶</div>
  </div>
</div>


<!-- Result -->
<div id="fruitResult" style="margin-top:15px;font-size:18px;color:var(--muted);"></div>

<!-- Public History -->
<h4 style="color:var(--gold);margin-top:20px">üìú Public Fruit History</h4>
<div style="max-height:200px;overflow:auto;margin-top:10px;">
<table style="width:100%;border-collapse:collapse;" id="fruitHistory">
<thead>
<tr>
<th>Period</th><th>Fruit</th><th>Time</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

</div>

  <!-- deposit -->
<div id="deposit" class="card full" style="margin-top:18px">
  <h3 style="color:var(--gold)">üí≥ Deposit</h3>

  <input id="depositAmt" type="number" min="1" placeholder="Amount (‚Çπ)"
         style="margin-top:10px;width:100%;padding:12px;border-radius:10px;
         background:#0b0b0f;border:none;color:#fff;font-size:15px;">

  <select id="depositType"
          style="margin-top:10px;width:100%;padding:12px;border-radius:10px;
          background:#0b0b0f;color:#fff;font-size:15px;">
    <option value="qr">Pay via QR</option>
    <option value="gpay">Google Pay</option>
    <option value="phonepe">PhonePe</option>
    <option value="paytm">Paytm</option>
  </select>

  <button class="btn gold" onclick="startDeposit()" 
          style="margin-top:12px;width:100%;padding:12px;font-size:16px;">
    Continue
  </button>
</div>

  <!-- withdraw -->
 <div id="withdraw" class="card full" style="display:none;margin-top:18px">

    <h3 style="color:var(--gold)">üè¶ Withdraw Money</h3>

    <!-- TYPE SELECTION -->
    <label style="color:#ccc;margin-top:10px;">Select Method</label>
      <select id="withdrawType" class="in" onchange="toggleWithdrawMethod()">
      <option value="upi">UPI</option>
      <option value="bank">Bank Account</option>
      </select>

    <!-- AMOUNT -->
    <input id="withdrawAmt" type="number" class="in" placeholder="Amount (‚Çπ)" style="margin-top:10px">

    <!-- UPI FIELD -->
    <div id="upiBox">
      <input id="withdrawUPI" type="text" class="in" placeholder="Enter UPI ID">
    </div>

    <!-- BANK FIELD -->
    <div id="bankBox" style="display:none;margin-top:10px">
      <div style="background:#111;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.1)">
          <div class="small">Bank Holder: <b id="wbHolder">-</b></div>
          <div class="small">Bank: <b id="wbBank">-</b></div>
          <div class="small">Account: <b id="wbNumber">-</b></div>
          <div class="small">IFSC: <b id="wbIFSC">-</b></div>
          <div class="small">Phone: <b id="wbPhone">-</b></div>
      </div>
    </div>

  <button class="btn gold" onclick="createWithdraw()" style="margin-top:12px">Request Withdraw</button>
 </div>

 <!-- profile -->
<div id="profile" class="card full" style="display:none;margin-top:18px">
  <h3 style="color:var(--gold)">üë§ Profile</h3>

  <div style="display:flex;align-items:center;gap:15px;margin-top:10px">
    <div style="
      width:60px;height:60px;border-radius:50%;
      background:linear-gradient(135deg,#7ef2b3,#42d3a2);
      display:flex;align-items:center;justify-content:center;
      font-size:24px;font-weight:700;color:#022;
    ">
      <span id="avatarLetter">F</span>
    </div>

    <div style="line-height:1.4">
      <div style="font-size:18px;font-weight:700" id="profileSavedName">‚Äî</div>
      <div class="small">UID: <b id="profileUID">‚Äî</b></div>
      <div class="small">Joined: <b id="joinedDate">‚Äî</b></div>
    </div>
  </div>

  <!-- PROFILE BOX -->
  <div class="profileBox">

    <h3 class="heading">üë§ Profile & Bank Details</h3>

    <!-- NAME -->
    <label class="label">Full Name</label>
    <input id="profileName" class="in" placeholder="Your Name">

    <div class="line"></div>

    <!-- BANK HOLDER -->
    <label class="label">Account Holder Name</label>
    <input id="bankHolder" class="in" placeholder="Enter Account Holder Name">

    <!-- BANK NAME -->
    <label class="label">Bank Name</label>
    <input id="bankName" class="in" placeholder="Enter Bank Name">

    <!-- ACCOUNT NUMBER -->
    <label class="label">Account Number</label>
    <input id="bankNumber" class="in" placeholder="Enter Account Number">

    <!-- IFSC -->
    <label class="label">IFSC Code</label>
    <input id="bankIfsc" class="in" placeholder="Enter IFSC Code">

    <!-- PHONE -->
    <label class="label">Phone Number</label>
    <input id="bankPhone" class="in" placeholder="Enter Phone Number">

    <button class="btn gold" onclick="saveProfile()" style="margin-top:10px">
      Save Details
    </button>

  </div>

  <h4 style="color:var(--gold);margin-top:15px">üî• Daily Streak</h4>
  <div class="small">
    Streak: <b id="streakCount">0</b> / 7
  </div>
  <div class="progress" style="margin-top:6px;height:14px;">
    <i id="streakBar" class="streak" style="width:0%"></i>
  </div>

  <button class="btn primary" onclick="claimDaily()" style="margin-top:12px;width:100%">
    Claim Daily Reward
  </button>

  <h4 style="color:var(--gold);margin-top:15px">üéí Inventory</h4>
  <div id="inventory" class="row"></div>

  <h3 style="color:var(--gold)">üöÄ Referral Promotion</h3>

  <div class="small">Your Level: <b id="shareLevel">0</b></div>
  <div class="progress" style="margin-top:6px;height:12px;">
    <i id="shareBar" style="width:0%;background:linear-gradient(90deg,#f6c94b,#ffd86b)"></i>
  </div>

  <div class="small" id="nextBonusInfo" style="margin-top:6px;">Referral Bonus: 0%</div>

  <div class="small" style="margin-top:10px">Total Invites: <b id="refInvites">0</b></div>
  <div class="small">Deposited Users: <b id="refDeposUsers">0</b></div>
  <div class="small">Bonus Earned: <b id="refBonus">‚Çπ0</b></div>

  <button class="btn primary" onclick="shareApp()" style="margin-top:10px;width:100%">
    üîó Share & Earn
  </button>

  <!-- ‚úÖ FINAL: Logout button INSIDE the profile -->
  <button class="btn" onclick="logoutUser()" 
          style="margin-top:20px;width:100%;background:#ff4c4c;color:#fff">
    üö™ Logout
  </button>

</div> <!-- END PROFILE -->

<!-- WALLET PAGE -->
<div id="wallet" class="card full" style="display:none;margin-top:18px">

  <h3 style="color:var(--gold)">üí∞ Wallet</h3>

  <!-- TOP SECTION BALANCE -->
  <div style="
      background:#1a1a1d;
      padding:16px;
      border-radius:12px;
      text-align:center;
      margin-bottom:18px;
      border:1px solid rgba(255,255,255,0.05);
    ">
    <div style="color:#aaa;font-size:14px;">Available Balance</div>
    <div style="font-size:26px;font-weight:800;color:#7ef2b3" id="walletBalance">‚Çπ0</div>

    <div style="color:#aaa;font-size:14px;margin-top:10px;">Bonus</div>
    <div style="font-size:20px;font-weight:700;color:#f6c94b" id="walletBonus">‚Çπ0</div>
  </div>

  <!-- ADD MONEY -->
  <button class="btn primary" onclick="openDeposit()" style="width:100%;padding:12px">
    ‚ûï Add Money
  </button>

  <!-- WITHDRAW -->
  <button class="btn gold" onclick="openWithdraw()" style="width:100%;padding:12px;margin-top:10px">
    üí∏ Withdraw Money
  </button>

  <!-- REDEEM CODE -->
  <button class="btn" onclick="openRedeemCode()" style="
      width:100%;padding:12px;margin-top:10px;
      background:#222;border:1px solid #333;color:#fff;
    ">
    üéÅ Redeem Code
  </button>

  <!-- BOTTOM WALLET BOX -->
  <div style="
      background:#111;
      margin-top:18px;
      padding:14px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.05);
    ">
  </div>

</div>

  <!-- history -->
  <div id="history" class="card full" style="display:none;margin-top:18px">
    <h3 style="color:var(--gold)">üìú History & Requests</h3>
    <input type="text" id="searchHistory" placeholder="Search farm id / crop..." onkeyup="filterTables()" style="margin-top:8px">
    <div style="margin-top:12px">
      <h4 style="color:var(--gold)">Farms</h4>
      <div style="max-height:220px;overflow:auto"><table id="farmsTable"><thead><tr><th>ID</th><th>Crop</th><th>Lots</th><th>Status</th><th>Profit</th></tr></thead><tbody></tbody></table></div>
      <h4 style="color:var(--gold);margin-top:10px">Deposits</h4>
      <div style="max-height:120px;overflow:auto"><table id="deposTable"><thead><tr><th>ID</th><th>Amt</th><th>Status</th></tr></thead><tbody></tbody></table></div>
      <h4 style="color:var(--gold);margin-top:10px">Withdraws</h4>
      <div style="max-height:120px;overflow:auto"><table id="withTable"><thead><tr><th>ID</th><th>Amt</th><th>Status</th></tr></thead><tbody></tbody></table></div>
      <h4 style="color:var(--gold);margin-top:10px">Fruit Bets</h4>
      <div style="max-height:220px;overflow:auto">
      <table id="fruitBetTable">
      <thead><tr><th>Period</th><th>Fruit</th><th>Qty</th><th>Amount</th></tr></thead><tbody></tbody></table>
      </div>

    </div>


  <div class="footer">¬© 2025 Farm2Earn ‚Äî stylish demo</div>
</div>

<!-- overlay popup (single shared) -->
<div class="overlay" id="overlayPopup">
  <div class="popup" id="popupBox">
    <span class="popup-close" id="popupClose">‚úñ</span>
    <div class="popup-content">
      <h2 id="popupTitle"></h2>
      <div id="popupBody" style="margin-top:8px"></div>
      <div id="popupProgressWrap" style="display:none;margin-top:12px">
        <div class="progress"><i id="popupProgressBar"></i></div>
      </div>
      <div style="margin-top:12px" id="popupActions"></div>
    </div>
  </div>
</div>

<!-- message container -->
<div id="msgContainer"></div>

<script>




/* =====================================================
   CONFIG
===================================================== */
const firebaseConfig = {
  apiKey: "AIzaSyDQsF4P9UmS0TZArvtvV6e_Fx3pBgNCBaY",
  authDomain: "farm2earning.firebaseapp.com",
  projectId: "farm2earning",
  storageBucket: "farm2earning.firebasestorage.app",
  messagingSenderId: "787325025832",
  appId: "1:787325025832:web:d30236c045fc5f3d7abf1d",
  measurementId: "G-LZYGJEYDQX"
};
/* =====================================================
   FORCE START FIREBASE (AFTER CONFIG)
===================================================== */
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let firebaseEnabled = true;
console.log("üî• Firebase Connected (Forced Init)");
// SAVE REFERRAL CODE FROM URL
(function detectReferral() {
  const url = new URLSearchParams(window.location.search);
  const ref = url.get("ref");
  if (ref) {
    localStorage.setItem("referralCode", ref);
    console.log("Referral saved:", ref);
  }
})();


const UPI_ID = "Q424657914@ybl";
const TEST_MODE = false;
const FARM_TIME_MS = TEST_MODE ? 5000 : 5 * 60 * 1000;

function writeDoc(col, id, data) {
  if (!firebaseEnabled || !db) return Promise.resolve();
  return db.collection(col).doc(String(id)).set(data)
    .catch(e => console.warn("Firestore write failed:", e));
}


function writeDoc(col, id, data) {
  if (!firebaseEnabled || !db) return Promise.resolve();
  return db.collection(col).doc(String(id)).set(data)
    .catch(e => console.warn("Firestore write failed:", e));
}

/* =====================================================
   STORAGE HELPERS
===================================================== */
function getStore(k, def) {
  try {
    const v = JSON.parse(localStorage.getItem(k));
    return v ?? def;
  } catch {
    return def;
  }
}
function setStore(k, v) {
  localStorage.setItem(k, JSON.stringify(v));
}

/* Initialize memory stores */
if (!getStore("users", null)) setStore("users", {});
if (!getStore("farms", null)) setStore("farms", []);
if (!getStore("deposits", null)) setStore("deposits", []);
if (!getStore("withdraws", null)) setStore("withdraws", []);

/* =====================================================
   CURRENT USER
===================================================== */
let users = getStore("users", {});   // GLOBAL users
let currentUser = getStore("currentUser", null);   // ‚≠ê MISSING LINE ADDED
// FORCE LOAD USER DATA AGAIN ON REFRESH
users = getStore("users", {});

function ensureUser() {
  // Always load fresh users
  users = getStore("users", {});

  let cu = getStore("currentUser", null);

  if (!cu) {
    window.location.href = "login.html";
    return null;
  }

  // If new user ‚Äì create
  if (!users[cu]) {
    users[cu] = {
      id: cu,
      name: "Player",
      balance: 0,
      coins: 0,
      joined: Date.now(),
      stats: { farms: 0, wins: 0, profit: 0 },
      inventory: {},
      daily: { lastClaim: "", streak: 0 },
      bank: null,
      upi: "",
      referredBy: localStorage.getItem("referralCode") || null
    };

    // ‚≠ê MUST SAVE HERE
    setStore("users", users);

    if (firebaseEnabled && db) writeDoc("users", cu, users[cu]);
  }

  return users[cu];
}

if (!currentUser) {
  window.location.href = "login.html";
  throw new Error("Not logged in");
}

/* =====================================================
   UTILITIES
===================================================== */
function randomID() {
  const L = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
  const N = "0123456789";
  return (
    "F2E-" +
    L[Math.floor(Math.random() * L.length)] +
    L[Math.floor(Math.random() * L.length)] +
    L[Math.floor(Math.random() * L.length)] +
    N[Math.floor(Math.random() * N.length)] +
    N[Math.floor(Math.random() * N.length)]
  );
}
function formatAmt(a) {
  return "‚Çπ" + Number(a).toLocaleString("en-IN");
}
function now() {
  return Date.now();
}
function coinToRupee(c) {
  return c / 100;
}

/* =====================================================
   CROP SETTINGS
===================================================== */
const CROP = {
  tomato: { 
    name: "Tomato",
    costPerLot: 200,
    daily: 20,
    days: 5
  },

  carrot: { 
    name: "Carrot",
    costPerLot: 150,
    daily: 15,
    days: 5
  },

  potato: { 
    name: "Potato",
    costPerLot: 250,
    daily: 25,
    days: 5
  }
};

function loadPublicFruitHistory() {
    if (!firebaseEnabled || !db) return;

    db.collection("fruitPublicHistory")
      .orderBy("time", "desc")
      .limit(30)
      .onSnapshot((snap) => {

        const tb = document.querySelector("#fruitHistory tbody");
        tb.innerHTML = "";

        if (snap.empty) {
            tb.innerHTML =
              "<tr><td colspan='3' style='text-align:center;opacity:0.5;'>No records</td></tr>";
            return;
        }

        snap.forEach(doc => {
            let h = doc.data();

            tb.innerHTML += `
            <tr>
                <td>${h.period}</td>
                <td>${
                    h.fruit === "apple" ? "üçé" :
                    h.fruit === "avocado" ? "ü•ë" :
                    h.fruit === "banana" ? "üçå" :
                    h.fruit === "grapes" ? "üçá" :
                    h.fruit === "orange" ? "üçä" :
                    "ü•≠"
                }</td>
                <td>${
                    new Date(h.time)
                      .toLocaleTimeString([], { hour:"2-digit", minute:"2-digit" })
                }</td>
            </tr>`;
        });
    });
}


/* =====================================================
   HEADER RENDER
===================================================== */
function renderHeader() {
  let me = ensureUser();
  if (!me) return;

  document.getElementById("meId").innerText = me.id;
  document.getElementById("meBal").innerText = formatAmt(me.balance || 0);
  document.getElementById("meCoins").innerText = me.coins || 0;
  document.getElementById("meFarms").innerText = me.stats?.farms || 0;

  document.getElementById("profileUID").innerText = me.id;
  document.getElementById("profileSavedName").innerText = me.name || "‚Äî";
  document.getElementById("profileName").value = me.name || "";
  document.getElementById("avatarLetter").innerText = (me.name?.[0] || "F").toUpperCase();
document.getElementById("joinedDate").innerText =
  me.joined ? new Date(me.joined).toLocaleDateString() : "‚Äî";

// ‚≠ê ADD THIS BLOCK (BANK DETAILS LOAD)
if (me.bank) {
  document.getElementById("wbHolder").innerText = me.bank.holder;
  document.getElementById("wbBank").innerText = me.bank.bank;
  document.getElementById("wbNumber").innerText = me.bank.number;
  document.getElementById("wbIFSC").innerText = me.bank.ifsc;
  document.getElementById("wbPhone").innerText = me.bank.phone;
  document.getElementById("walletBalance").innerText = formatAmt(me.balance);
  document.getElementById("walletBonus").innerText = formatAmt(me.bonus || 0);

}

const streak = me.daily?.streak || 0;
document.getElementById("streakCount").innerText = streak;
document.getElementById("streakBar").style.width = (streak / 7) * 100 + "%";

renderInventory();
renderTables();
}

/* =====================================================
   INVENTORY
===================================================== */
function renderInventory() {
  let me = ensureUser();
  const cont = document.getElementById("inventory");
  cont.innerHTML = "";

  if (!me.inventory || Object.keys(me.inventory).length === 0) {
    cont.innerHTML = "<div class='small'>No items</div>";
    return;
  }

  Object.entries(me.inventory).forEach(([k, v]) => {
    const e = document.createElement("div");
    e.style.padding = "6px 10px";
    e.style.background = "rgba(255,255,255,0.03)";
    e.style.borderRadius = "8px";
    e.innerHTML = `<b>${k}</b> x ${v}`;
    cont.appendChild(e);
  });
}

/* =====================================================
   PAGE SWITCH
===================================================== */
function show(page) {
    ["farm", "fruit", "deposit", "withdraw", "wallet", "profile", "history"]
        .forEach(id => {
            let el = document.getElementById(id);
            if (!el) return;
            el.style.display = (id === page ? 
                (id === "farm" ? "grid" : "block") : "none");
        });

    if (page === "history") {
        renderTables();
        loadFruitBetHistory();
    }

    if (page === "profile") renderProfile();
    if (page === "wallet") renderWallet();   // ‚≠ê ADD THIS
}
function renderWallet() {
    let me = ensureUser();

    document.getElementById("walletBalance").innerText =
        "‚Çπ" + Number(me.balance || 0).toLocaleString("en-IN");

    document.getElementById("walletBonus").innerText =
        "‚Çπ" + Number(me.bonus || 0).toLocaleString("en-IN");
}




/* =====================================================
      NOTICE (HOME PAGE CARD)
===================================================== */
function renderNoticeCard() {
  const card = document.getElementById("noticeCard");
  const txt = document.getElementById("noticeText");
  const tm = document.getElementById("noticeTime");

  if (!card) return;

  const dismissed = getStore("noticeDismiss_" + currentUser, false);
  if (dismissed) {
    card.style.display = "none";
    return;
  }

  const notice = getStore("latestNotice", null);
  if (!notice || !notice.text) {
    card.style.display = "none";
    return;
  }

  txt.innerText = notice.text;
  tm.innerText = "Updated: " + new Date(notice.ts).toLocaleString();
  card.style.display = "block";
}

function dismissNotice() {
  setStore("noticeDismiss_" + currentUser, true);
  document.getElementById("noticeCard").style.display = "none";
}

async function loadNoticeFromFirestore() {
  if (!firebaseEnabled || !db) {
    renderNoticeCard();
    return;
  }

  try {
    const docSnap = await db.collection("notices").doc("global").get();
    if (docSnap.exists) {
      const n = docSnap.data();
      setStore("latestNotice", n); // LOCAL SAVE
    }
  } catch (e) {
    console.warn("Notice load failed:", e);
  }

  renderNoticeCard();
}


/* =====================================================
   POPUPS + TOAST
===================================================== */
function openPopup(title, body, actions = "", showProgress = false) {
  popupTitle.innerText = title;
  popupBody.innerHTML = body;
  popupActions.innerHTML = actions;

  popupProgressWrap.style.display = showProgress ? "block" : "none";
  popupProgressBar.style.width = "0%";

  overlayPopup.style.display = "flex";

  // ‚≠ê CLOSE FIX ‚Äî HAR POPUP KE LIYE
  document.getElementById("popupClose").onclick = closePopup;
}

function closePopup() {
  overlayPopup.style.display = "none";
}
function showMessage(msg, type = "info") {
  const box = document.createElement("div");
  box.className = `msgBox ${type}`;
  box.innerText = msg;
  document.body.appendChild(box);
  setTimeout(() => box.classList.add("show"), 20);
  setTimeout(() => {
    box.classList.remove("show");
    setTimeout(() => box.remove(), 500);
  }, 3000);
}

/* =====================================================
   LOGOUT
===================================================== */
function logoutUser() {
  localStorage.removeItem("currentUser");
  showMessage("Logged out!", "info");
  setTimeout(() => (window.location.href = "login.html"), 600);
}
/* =====================================================
   SEED DROP ANIMATION
===================================================== */
function dropSeeds(emoji="üå±") {
  for (let i = 0; i < 7; i++) {
    const seed = document.createElement("div");
    seed.className = "seed";
    seed.innerText = emoji;

    seed.style.left = Math.random() * window.innerWidth + "px";
    seed.style.animationDelay = (Math.random() * 0.3) + "s";
    seed.style.transform = "rotate(" + (Math.random()*60 - 30) + "deg)";

    document.body.appendChild(seed);

    setTimeout(() => seed.remove(), 1500);
  }
}
/* =====================================================
   ****** FARMING (WORKING PERFECT) ******
===================================================== */

function openFarmPopup(cropKey) {
  const crop = CROP[cropKey];
  const lots = Math.max(1, parseInt(document.getElementById(cropKey + "Lots").value) || 1);

  const invest = crop.costPerLot * lots;
  const daily = crop.daily * lots;
  const total = daily * crop.days;

  openPopup(
    `Start ${crop.name}`,
    `
      <div><b>${crop.name}</b> ‚Äî ${lots} lot(s)</div>
      <div class='small'>
        Invest: <b>‚Çπ${invest}</b><br>
        Daily Return: <b>‚Çπ${daily}</b><br>
        Total Return: <b>‚Çπ${total}</b><br>
        Duration: <b>${crop.days} Days</b>
      </div>
    `,
    `<button class='btn gold' onclick="confirmStartFarm('${cropKey}', ${lots})">Confirm</button>`
  );
}


function confirmStartFarm(cropKey, lots) {
  closePopup();
  dropSeeds(cropKey === "tomato" ? "üçÖ" : cropKey === "carrot" ? "ü•ï" : "ü•î");
  startFarm(cropKey, lots);
}

function startFarm(cropKey, lots) {
  let users = getStore("users", {});
  let me = ensureUser();
  const crop = CROP[cropKey];

  const invest = crop.costPerLot * lots;
  const daily = crop.daily * lots;
  const total = daily * crop.days;

  if (me.balance < invest)
      return showMessage("Insufficient Balance!", "error");

  me.balance -= invest;
  users[currentUser] = me;
  setStore("users", users);
  if (firebaseEnabled && db) writeDoc("users", currentUser, me);

  const id = randomID();

  const farm = {
    id,
    owner: currentUser,
    crop: cropKey,
    cropName: crop.name,
    invest,
    dailyReturn: daily,
    totalReturn: total,
    daysCompleted: 0,
    totalDays: crop.days,
    nextPayout: Date.now() + 24*60*60*1000,
    createdAt: Date.now(),
    earned: 0,
    status: "running"
  };

  const arr = getStore("farms", []);
  arr.unshift(farm);
  setStore("farms", arr);
  if (firebaseEnabled && db) writeDoc("farms", farm.id, farm);

  renderHeader();
  renderTables();

  showMessage("Farm Started Successfully!", "success");
  closePopup();
}
async function claimFarmIncome(farmId) {

  const farmRef = db.collection("farms").doc(farmId);
  const farmSnap = await farmRef.get();
  const farm = farmSnap.data();

  if (!farm) return;

  if (farm.daysCompleted >= farm.totalDays)
      return showMessage("Farm Completed!", "info");

  if (Date.now() < farm.nextPayout) {
      let hr = Math.ceil((farm.nextPayout - Date.now()) / (1000*60*60));
      return showMessage(`Come back after ${hr} hours`, "error");
  }

  const userRef = db.collection("users").doc(farm.owner);
  const user = (await userRef.get()).data();

  await userRef.update({
    balance: (user.balance || 0) + farm.dailyReturn
  });

  await farmRef.update({
    daysCompleted: farm.daysCompleted + 1,
    earned: farm.earned + farm.dailyReturn,
    nextPayout: Date.now() + 24*60*60*1000,
    status: farm.daysCompleted + 1 === farm.totalDays ? "completed" : "running"
  });

  showMessage(`+‚Çπ${farm.dailyReturn} credited!`, "success");
}


function settleFarm(id) {
  const farms = getStore("farms", []);
  const idx = farms.findIndex((f) => f.id === id);
  if (idx === -1) return;

  const f = farms[idx];

  // ‚≠ê ADMIN FORCE SETTLED FARM ‚Äî DO NOT RE-CALCULATE
  if (f.adminForced) {
    farms[idx] = f;
    setStore("farms", farms);

    let me = ensureUser();
    users[currentUser] = me;
    setStore("users", users);

    renderHeader();
    renderTables();

    openPopup(
      "üåæ Admin Settled Farm",
      `<div><b>Wins:</b> ${f.wins}</div>
       <div><b>Profit:</b> ‚Çπ${f.profit}</div>
       <h2>${f.profit >= 0 ? "üéâ WIN" : "‚ùå LOSS"}</h2>`,
      `<button class='btn gold' onclick='closePopup()'>OK</button>`
    );

    return; // ‚≠ê STOP normal settlement
  }

  // (OLD CODE BELOW CONTINUES FOR NORMAL FARM)


  const cfg = CROP[f.crop];

  // ‚≠ê GET ADMIN MODE LIVE
  const settings = getStore("adminSettings", { globalForceMode: "normal" });
  const mode = settings.globalForceMode;

  let totalWins = 0;

  if (mode === "force-win") {
    // ‚≠ê Full win
    totalWins = cfg.lotSize * f.lots;

  } else if (mode === "force-lose") {
    // ‚≠ê Full loss
    totalWins = 0;

  } else {
    // ‚≠ê Normal 3‚Äì5% chance
    for (let i = 0; i < cfg.lotSize * f.lots; i++) {
      if (Math.random() * 100 < cfg.chance) totalWins++;
    }
  }

  const totalReturn = totalWins * cfg.returnPerItem;
  const profit = totalReturn - f.cost;

  f.status = "finished";
  f.wins = totalWins;
  f.profit = profit;

  farms[idx] = f;
  setStore("farms", farms);

  let users = getStore("users", {});
  let me = users[currentUser];
  me.balance += totalReturn;

  users[currentUser] = me;
  setStore("users", users);

  renderHeader();
  renderTables();

  openPopup(
    "üåæ Result",
    `
      <div><b>Wins:</b> ${totalWins}</div>
      <div><b>Profit:</b> ‚Çπ${profit}</div>
      <h2>${profit >= 0 ? "üéâ WIN" : "‚ùå LOSS"}</h2>
    `,
    `<button class='btn gold' onclick='closePopup()'>OK</button>`
  );
}

function animateShowPopup() {
    const pop = document.getElementById("noticePopup");
    const box = document.getElementById("popupBox");

    pop.style.display = "flex";

    setTimeout(() => {
        pop.style.opacity = "1";
        box.style.opacity = "1";
        box.style.transform = "scale(1)";
    }, 20);
}
/* =====================================================
   FRUIT TRADING GAME (FINAL FIREBASE VERSION)
=====================================================*/
function animateHidePopup(callback) {
    const pop = document.getElementById("noticePopup");
    const box = document.getElementById("popupBox");

    pop.style.opacity = "0";
    box.style.opacity = "0";
    box.style.transform = "scale(0.7)";

    setTimeout(() => {
        pop.style.display = "none";
        if (callback) callback();
    }, 500);
}
let popupCountdown = 3;

function animateShowPopup() {
    const pop = document.getElementById("noticePopup");
    const box = document.getElementById("popupBox");

    pop.style.display = "flex";

    setTimeout(() => {
        pop.style.opacity = "1";
        box.style.opacity = "1";
        box.style.transform = "scale(1) translateY(0)";
    }, 20);

    startCountdownRing();
}

// countdown ring logic
function startCountdownRing() {
    popupCountdown = 3;
    const timerText = document.getElementById("popupTimer");
    const ring = document.querySelector(".ringProg");

    timerText.innerText = popupCountdown;

    const intv = setInterval(() => {
        popupCountdown--;
        timerText.innerText = popupCountdown;

        // animate ring
        ring.style.strokeDashoffset = (226 * (3 - popupCountdown)) / 3;

        if (popupCountdown <= 0) {
            clearInterval(intv);
            animateHidePopup(openGameDefault);
        }
    }, 1000);
}



/* =====================================================
   FRUIT TRADING GAME (FINAL FIREBASE VERSION)
=====================================================*/
async function handleNoticePopup() {
  if (!firebaseEnabled || !db) {
    openGameDefault();
    return;
  }

  const snap = await db.collection("notices").doc("global").get();
  if (!snap.exists) {
    openGameDefault();
    return;
  }

  const data = snap.data();

  document.getElementById("npText").innerText = data.text;
  document.getElementById("npTime").innerText =
    "Updated: " + new Date(data.ts).toLocaleTimeString([], {
      hour:"2-digit",
      minute:"2-digit"
    });

  animateShowPopup(); // üéâ PRO animation
}

function openGameDefault() {
  show("fruit");
}








/* =====================================================
   FRUIT TRADING ‚Äî FINAL ADMIN VERSION (Firebase)
=====================================================*/
function loadReferralStats() {
    let me = ensureUser();
    let stats = me.referralStats || { invites: 0, depositUsers: 0, bonusEarned: 0 };

    const level = getReferralLevel(stats.invites);
    const percent = getBonusPercent(level);

    document.getElementById("refInvites").innerText = stats.invites;
    document.getElementById("refDeposUsers").innerText = stats.depositUsers;
    document.getElementById("refBonus").innerText = "‚Çπ" + stats.bonusEarned;
    document.getElementById("shareLevel").innerText = "Level " + level;

    // Progress bar (0‚Äì10 level)
    document.getElementById("shareBar").style.width = (level * 10) + "%";

    document.getElementById("nextBonusInfo").innerText =
        `Referral Bonus: ${percent}%`;
}

async function increaseInviteCount(refID) {
    let u = getStore("users", {});
    if (!u[refID]) return;

    if (!u[refID].referralStats)
        u[refID].referralStats = { invites: 0, depositUsers: 0, bonusEarned: 0 };

    u[refID].referralStats.invites += 1;

    setStore("users", u);
    await writeDoc("users", refID, u[refID]);
}
function getReferralLevel(invites) {
    return Math.min(10, Math.floor(invites / 3)); 
}
function getBonusPercent(level) {
    return level * 3;   // Level 1 = 3%, Level 10 = 30%
}
async function giveReferralBonus(deposit) {
    let users = getStore("users", {});
    const user = users[deposit.owner];
    if (!user || !user.referredBy) return;

    const refID = user.referredBy;
    const refUser = users[refID];
    if (!refUser) return;

    // Already given?
    if (deposit.referralPaid) return;

    // Ensure referral stats exist
    if (!refUser.referralStats)
        refUser.referralStats = { invites: 0, depositUsers: 0, bonusEarned: 0 };

    // Level based on invites
    const level = getReferralLevel(refUser.referralStats.invites);

    // Bonus %
    const percent = getBonusPercent(level); // e.g. Level 5 = 15%

    // Calculate bonus amount
    const bonus = Math.floor((deposit.amount * percent) / 100);

    // Add bonus to referrer wallet
    refUser.balance += bonus;
    refUser.referralStats.depositUsers += 1;
    refUser.referralStats.bonusEarned += bonus;

    // Mark deposit as paid
    deposit.referralPaid = true;

    // Save both in Firebase
    if (firebaseEnabled && db) {
        await writeDoc("users", refID, refUser);
        await writeDoc("deposits", deposit.id, deposit);
    }

    // Save locally
    setStore("users", users);

    console.log(`üí∞ Referral Bonus Given: Level ${level} ‚Üí ${percent}% ‚Üí ‚Çπ${bonus}`);
}



/* =====================================================
   FRUIT TRADING GAME ‚Äì FINAL FIXED VERSION
===================================================== */

let selectedFruit = null;
let fruitQty = 0;
let fruitBetAmount = 0;
let fruitCurrentPeriod = "";
let fruitTimeLeft = 120;
let fruitTimerInterval = null;


/* =====================================================
    UPDATE TIMER ON SCREEN
===================================================== */
function updateFruitTimer() {
    const m = Math.floor(fruitTimeLeft / 60);
    const s = fruitTimeLeft % 60;
    document.getElementById("fruitTimer").innerText =
        `${m}:${s.toString().padStart(2, "0")}`;
}


/* =====================================================
    START TIMER
===================================================== */
function startFruitTimer() {
    if (fruitTimerInterval) clearInterval(fruitTimerInterval);

    updateFruitTimer();

    fruitTimerInterval = setInterval(() => {

        fruitTimeLeft--;
        updateFruitTimer();

        if (fruitTimeLeft <= 0) {
            clearInterval(fruitTimerInterval);
            showResultCountdown();
        }

    }, 1000);
}
function showResultCountdown() {
    const box = document.getElementById("countdownPopup");
    const num = document.getElementById("cd-number");

    box.style.display = "flex";

    let cd = 10;
    num.innerText = cd;

    const t = setInterval(() => {
        cd--;
        num.innerText = cd;

        if (cd <= 0) {
            clearInterval(t);

            generateFruitResult(fruitCurrentPeriod).then(async (f) => {

            document.getElementById("fruitResult").innerHTML =
            "<b>Result:</b> " + f.toUpperCase();

           setTimeout(async () => {
            box.style.display = "none";
            console.log("‚≠ê Creating NEW period after result");
            await createNewFruitPeriod();
            }, 1500);

          });

        }

    }, 1000);
}

function writeUser(uid, data) {
    if (!firebaseEnabled || !db) return;
    return db.collection("users").doc(uid).set(data);
}



    


/* =====================================================
    CREATE NEW PERIOD (AUTO)
===================================================== */
async function createNewFruitPeriod() {
    const last = Number(getStore("fruitLast", 0)) + 1;
    setStore("fruitLast", last);

    const period = "F2E-BAL08-" + String(last).padStart(5, "0");
    const start = Date.now();
    const end = start + (2 * 60 * 1000);

    fruitCurrentPeriod = period;
    fruitTimeLeft = 120;

    document.getElementById("fruitPeriod").innerText = period;
    document.getElementById("fruitResult").innerHTML = "";

    await fbWrite("fruitPeriods", period, {
        period,
        startTime: start,
        endTime: end,
        server: true
    });

    startFruitTimer();
}





/* =====================================================
   USER CHOICES
===================================================== */
function chooseFruit(fruit, el) {
    selectedFruit = fruit;

    document.querySelectorAll(".fruitBtn")
        .forEach(btn => btn.classList.remove("betSelected"));

    el.classList.add("betSelected");

    console.log("Fruit Selected:", selectedFruit);
}



function chooseQty(q, el) {
    fruitQty = q;

    document.querySelectorAll(".qtyBtn")
        .forEach(btn => btn.classList.remove("betSelected"));

    el.classList.add("betSelected");

    console.log("Qty Selected:", fruitQty);
}



function chooseAmount(a, el) {
    fruitBetAmount = a;

    document.querySelectorAll(".amtBtn")
        .forEach(btn => btn.classList.remove("betSelected"));

    el.classList.add("betSelected");

    console.log("Amount Selected:", fruitBetAmount);
}



/* =====================================================
   CONFIRM BET (FINAL FIXED)
===================================================== */
// Always return correct active period
function getActiveFruitPeriod() {
    if (fruitCurrentPeriod && fruitCurrentPeriod.length > 0)
        return fruitCurrentPeriod;

    const last = getStore("lastFruitPeriod", null);
    if (last) return last;

    return "F2E-BAL08-00001";
}

/* =====================================================
   GENERATE RANDOM FRUIT RESULT FOR EACH PERIOD
===================================================== */
function openDeposit() {
    show("deposit");
}
function openWithdraw() {
    show("withdraw");
}
function openRedeemCode() {
    openPopup(
        "üéÅ Redeem Code",
        `<input id='redeemInput' class='in' placeholder='Enter redeem code'>`,
        `<button class='btn gold' onclick='applyRedeem()'>Apply</button>`
    );
}
async function applyRedeem() {
    let code = document.getElementById("redeemInput").value.trim().toUpperCase();
    if (!code) return showMessage("Enter a valid redeem code!", "error");

    const doc = await db.collection("redeemCodes").doc(code).get();

    if (!doc.exists) return showMessage("Invalid code!", "error");

    let data = doc.data();

    if (!data.active) return showMessage("This code is disabled!", "error");
    if (data.uses <= 0) return showMessage("Code expired!", "error");

    // User Data
    let me = ensureUser();

    // Add credit
    me.balance += data.amount;
    me.bonus = (me.bonus || 0) + data.amount;

    await db.collection("users").doc(currentUser).update(me);

    // Reduce usage
    await db.collection("redeemCodes").doc(code).update({
        uses: data.uses - 1
    });

    closePopup();
    renderHeader();
    renderWallet();

    showMessage("Success! You received ‚Çπ" + data.amount, "success");
}


/* =====================================================
   GENERATE REAL RANDOM RESULT FOR THIS PERIOD
===================================================== */
/* =====================================================
   GENERATE REAL RANDOM RESULT
===================================================== */
async function generateFruitResult(period) {
    let forced = null;

    if (firebaseEnabled && db) {
        const doc = await db.collection("forceFruitResult").doc(period).get();
        if (doc.exists && doc.data().locked) {
            forced = doc.data().fruit;
        }
    }

    const fruits = ["apple","banana","mango","grapes","avocado","orange"];
    const winFruit = forced || fruits[Math.floor(Math.random()*fruits.length)];

    if (firebaseEnabled && db) {
        db.collection("fruitPublicHistory").doc(period).set({
            period,
            fruit: winFruit,
            time: Date.now()
        });
    }

    const bets = await db.collection("fruitBets")
        .where("period", "==", period)
        .where("fruit", "==", winFruit)
        .get();

    const usersLocal = getStore("users", {});

    bets.forEach(async (b) => {
        const data = b.data();
        const win = (data.qty * data.baseAmount) * 2;

        usersLocal[data.uid].balance += win;

        if (firebaseEnabled && db) {
            await writeUser(data.uid, usersLocal[data.uid]);
        }

        setStore("users", usersLocal);
    });

    return winFruit;
}



async function confirmFruitBet() {

    if (!selectedFruit) return showMessage("Select Fruit!", "error");
    if (!fruitQty) return showMessage("Select Quantity!", "error");
    if (!fruitBetAmount) return showMessage("Select Amount!", "error");

    let me = ensureUser();
    const finalAmt = fruitQty * fruitBetAmount;

    if (me.balance < finalAmt) {
        return showMessage("Insufficient Balance!", "error");
    }

    me.balance -= finalAmt;
    users[currentUser] = me;
    setStore("users", users);
    if (firebaseEnabled && db) writeDoc("users", currentUser, me);

    const betID = currentUser + "_" + Date.now();

    const periodNow =
    (fruitCurrentPeriod && fruitCurrentPeriod.length > 5)
    ? fruitCurrentPeriod
    : getStore("lastFruitPeriod") || "F2E-BAL08-00001";

   // üî• FINAL FIX

    const bet = {
        id: betID,
        uid: currentUser,
        fruit: selectedFruit,
        qty: fruitQty,
        baseAmount: fruitBetAmount,
        amount: finalAmt,
        period: periodNow,
        time: Date.now()
    };

    if (firebaseEnabled && db) {

        await db.collection("fruitBets").doc(betID).set(bet);
    }

    showMessage(`Bet Placed Successfully!`, "success");
    renderHeader();
}



/* =====================================================
   LOAD USER BET HISTORY
===================================================== */
function loadFruitBetHistory() {
    if (!firebaseEnabled || !db) return;

    const uid = currentUser;

    db.collection("fruitBets")
        .where("uid", "==", uid)
        .orderBy("time", "desc")
        .limit(20)
        .onSnapshot((snap) => {

            const tb = document.querySelector("#fruitBetTable tbody");
            tb.innerHTML = "";

            if (snap.empty) {
                tb.innerHTML =
                    "<tr><td colspan='4' style='text-align:center;opacity:0.5;'>No bets yet</td></tr>";
                return;
            }

            snap.forEach(doc => {
                let b = doc.data();

                tb.innerHTML += `
                    <tr>
                        <td>${b.period ? b.period : "‚Äî"}</td>
                        <td>${
                            b.fruit === "apple" ? "üçé" :
                            b.fruit === "avocado" ? "ü•ë" :
                            b.fruit === "banana" ? "üçå" :
                            b.fruit === "grapes" ? "üçá" :
                            b.fruit === "orange" ? "üçä" : "ü•≠"
                        }</td>
                        <td>√ó${b.qty}</td>
                        <td>‚Çπ${b.amount}</td>
                    </tr>
                `;
            });
        });
}



/* =====================================================
   QUICK FARM
===================================================== */
function settleQuickFarm(id) {
  const farms = getStore("farms", []);
  const idx = farms.findIndex((f) => f.id === id);
  if (idx === -1) return;

  const f = farms[idx];

  // FIXED: cfg add
  const cfg = CROP.tomato;

  let wins = 0;
  for (let i = 0; i < 5; i++) {
    if (Math.random() * 100 < cfg.chance) wins++;
  }

  const totalReturn = wins * cfg.returnPerItem;
  const profit = totalReturn - 50;

  f.wins = wins;
  f.profit = profit;
  f.status = "finished";
  f.finishedAt = now();
  farms[idx] = f;
  setStore("farms", farms);
  if (firebaseEnabled && db) writeDoc("farms", f.id, f);

  let me = ensureUser();
  me.balance += totalReturn;

  me.stats.farms += 1;
  me.stats.wins += wins;
  me.stats.profit += profit;

  users[currentUser] = me;
  setStore("users", users);
  if (firebaseEnabled && db) writeDoc("users", currentUser, me);

  renderHeader();
  renderTables();

  closePopup();
  showMessage(`Quick Profit: ${formatAmt(profit)}`, profit >= 0 ? "success" : "error");
}


/* =====================================================
   DEPOSIT
===================================================== */
/* =====================================================
   GLOBAL
===================================================== */
const UPI = "Q424657914@ybl";
let __lastDepositAmt = 0;

/* =====================================================
   START DEPOSIT
===================================================== */
function startDeposit() {
  const amt = parseInt(document.getElementById("depositAmt").value) || 0;
  const type = document.getElementById("depositType").value;

  if (amt < 100) return showMessage("Min ‚Çπ100", "error");
  if (amt > 20000) return showMessage("Max ‚Çπ20,000", "error");

  __lastDepositAmt = amt;

  if (type === "qr") return depositViaQR(amt);
  if (type === "gpay") return payGPay(UPI_ID, amt);
  if (type === "phonepe") return payPhonePe(UPI_ID, amt);
  if (type === "paytm") return payPaytm(UPI_ID, amt);
}


/* =====================================================
   UNIVERSAL PAYMENT POPUP (QR)
===================================================== */
function depositViaQR(amt) {
  const upiLink = `upi://pay?pa=${UPI_ID}&pn=Farm2Earn&am=${amt}&cu=INR`;

  const qrImg =
    `https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=${encodeURIComponent(upiLink)}`;

  let mobileButtons = `
    <button class="btn primary" onclick="payGPay('${UPI_ID}', ${amt})" style="width:100%;margin-top:10px;">Google Pay</button>
    <button class="btn primary" onclick="payPhonePe('${UPI_ID}', ${amt})" style="width:100%;margin-top:10px;">PhonePe</button>
    <button class="btn primary" onclick="payPaytm('${UPI_ID}', ${amt})" style="width:100%;margin-top:10px;">Paytm</button>
  `;

  openPopup(
    "Scan to Pay",
    `
      <div style="text-align:center">
        <img src="${qrImg}" width="220" height="220" style="border-radius:12px;">
      </div>
      <div class='small'>Amount: ‚Çπ${amt}</div>
      <div style='margin-top:10px'>Or pay using UPI app:</div>
    `,
    `
      ${mobileButtons}
      <button class='btn gold' onclick="finishDeposit()" style="width:100%;margin-top:10px;">DONE</button>
    `
  );
}


/* =====================================================
   UPI INTENT - 3 STEP UNIVERSAL FALLBACK
===================================================== */
function openIntent(intentURL, fallbackURL, qrFallback) {
  let tried = false;

  const iframe = document.createElement("iframe");
  iframe.style.display = "none";
  iframe.src = intentURL;
  document.body.appendChild(iframe);

  // Fallback after 1.2s
  setTimeout(() => {
    if (!tried) {
      tried = true;
      window.location.href = fallbackURL;
    }
  }, 1200);

  // Final fallback after 2.2s ‚Üí QR popup
  setTimeout(() => {
    if (!tried) {
      tried = true;
      qrFallback();
    }
  }, 2200);
}

/* =====================================================
   PAY WITH GOOGLE PAY
===================================================== */
function payGPay(upi, amt) {
  const intentURL =
    `intent://pay?pa=${upi}&pn=Farm2Earn&am=${amt}&cu=INR#Intent;scheme=upi;package=com.google.android.apps.nbu.paisa.user;end;`;

  const fallbackURL = `upi://pay?pa=${upi}&pn=Farm2Earn&am=${amt}`;

  openIntent(intentURL, fallbackURL, () => depositViaQR(amt));
}

/* =====================================================
   PAY WITH PHONEPE
===================================================== */
function payPhonePe(upi, amt) {
    const intentURL =
        `intent://pay?pa=${upi}&pn=Farm2Earn&am=${amt}&cu=INR#Intent;scheme=upi;package=com.phonepe.app;end;`;

    const fallbackURL =
        `phonepe://pay?pa=${upi}&pn=Farm2Earn&am=${amt}&cu=INR`;

    openIntent(intentURL, fallbackURL, () => depositViaQR(amt));
}


/* =====================================================
   PAY WITH PAYTM
===================================================== */
function payPaytm(upi, amt) {
    const intentURL =
        `intent://pay?pa=${upi}&pn=Farm2Earn&am=${amt}&cu=INR#Intent;scheme=upi;package=net.one97.paytm;end;`;

    const fallbackURL =
        `paytm://upi/pay?pa=${upi}&pn=Farm2Earn&am=${amt}&cu=INR`;

    openIntent(intentURL, fallbackURL, () => depositViaQR(amt));
}


/* =====================================================
   FINISH DEPOSIT
===================================================== */
function finishDeposit() {
  const amt = __lastDepositAmt;
  closePopup();

  const id = randomID();
  const d = {
    id,
    owner: currentUser,
    amount: amt,
    status: "pending",
    created: now()
  };

  const arr = getStore("deposits", []);
  arr.unshift(d);
  setStore("deposits", arr);

  if (firebaseEnabled && db) writeDoc("deposits", id, d);

  renderTables();
  showMessage("Deposit request submitted!", "success");
}

/* =====================================================
   WITHDRAW
===================================================== */
function toggleWithdrawMethod() {
  const t = document.getElementById("withdrawType").value;

  document.getElementById("upiBox").style.display = t === "upi" ? "block" : "none";
  document.getElementById("bankBox").style.display = t === "bank" ? "block" : "none";

  if (t === "bank") {
    let me = ensureUser();
    if (me.bank) {
      document.getElementById("wbHolder").innerText = me.bank.holder;
      document.getElementById("wbBank").innerText = me.bank.bank;
      document.getElementById("wbNumber").innerText = me.bank.number;
      document.getElementById("wbIFSC").innerText = me.bank.ifsc;
      document.getElementById("wbPhone").innerText = me.bank.phone;
    }
  }
}

function createWithdraw() {
  const amt = parseInt(document.getElementById("withdrawAmt").value) || 0;
  const type = document.getElementById("withdrawType").value;

  let me = ensureUser();

  if (amt < 500) return showMessage("Min ‚Çπ500", "error");
  if (amt > 10000) return showMessage("Max ‚Çπ10,000", "error");
  if (me.balance < amt) return showMessage("Insufficient funds!", "error");

  let note = "";

  if (type === "upi") {
    note = document.getElementById("withdrawUPI").value.trim();
    if (!note) return showMessage("Enter UPI!", "error");
  } else {
    if (!me.bank) return showMessage("Add bank details first!", "error");
    note = `Holder: ${me.bank.holder}, Bank: ${me.bank.bank}, AC: ${me.bank.number}`;
  }

  me.balance -= amt;
  users[currentUser] = me;
  setStore("users", users);
  if (firebaseEnabled && db) writeDoc("users", currentUser, me);

  const id = randomID();
  const w = {
    id,
    owner: currentUser,
    amount: amt,
    method: type,
    note,
    status: "pending",
    created: now()
  };

  const arr = getStore("withdraws", []);
  arr.unshift(w);
  setStore("withdraws", arr);
  if (firebaseEnabled && db) writeDoc("withdraws", id, w);

  renderHeader();
  renderTables();

  openPopup(
    "Withdraw Submitted",
    `
      <div class="successTick">
        <svg viewBox="0 0 52 52">
          <path d="M14 27 l7 7 l17 -17"></path>
        </svg>
      </div>
      <div class="small">Your withdraw request is submitted!</div>
      <div class="small">Amount: ‚Çπ${amt}</div>
    `,
    `<button class='btn gold' onclick='closePopup()'>OK</button>`
  );
}

/* -------- FRUIT BETS (your history only) -------- */


/* =====================================================
   PROFILE
===================================================== */
function renderProfile() {
  let me = ensureUser();

  document.getElementById("profileName").value = me.name || "";

  if (me.bank) {
    document.getElementById("bankHolder").value = me.bank.holder;
    document.getElementById("bankName").value = me.bank.bank;
    document.getElementById("bankNumber").value = me.bank.number;
    document.getElementById("bankIfsc").value = me.bank.ifsc;
    document.getElementById("bankPhone").value = me.bank.phone;
  }

  if (me.upi) {
    document.getElementById("withdrawUPI").value = me.upi;
  }
}

function saveProfile() {
  let me = ensureUser();

  const name = document.getElementById("profileName").value.trim();
  const holder = document.getElementById("bankHolder").value.trim();
  const bank = document.getElementById("bankName").value.trim();
  const number = document.getElementById("bankNumber").value.trim();
  const ifsc = document.getElementById("bankIfsc").value.trim();
  const phone = document.getElementById("bankPhone").value.trim();

  if (!name) return showMessage("Enter name!", "error");
  if (!holder || !bank || !number || !ifsc || !phone)
    return showMessage("Fill all bank details!", "error");

  me.name = name;
  me.bank = { holder, bank, number, ifsc, phone };

  users[currentUser] = me;
  setStore("users", users);
  users = getStore("users", {});   // ‚≠ê FIX ‚Äì GLOBAL users updated
  if (firebaseEnabled && db) writeDoc("users", currentUser, me);

renderHeader();
showMessage("Profile saved!", "success");

}

/* =====================================================
   DAILY REWARD
===================================================== */
function claimDaily() {
  let me = ensureUser();
  let users = getStore("users", {});

  const today = new Date().toISOString().slice(0, 10);  // YYYY-MM-DD

  if (!me.daily) me.daily = { lastClaim: "", streak: 0 };

  const last = me.daily.lastClaim;

  // Already claimed today
  if (last === today) {
    return showMessage("Already claimed today!", "error");
  }

  // Check streak reset
  if (last) {
    const gap = (
    parseInt(today.replace(/-/g, "")) -
    parseInt(last.replace(/-/g, ""))
);

    if (gap > 1) me.daily.streak = 0;  // More than 1 day gap = reset
  }

  // Increase streak
  me.daily.streak += 1;

  // Reward coins
  let reward = 5;

  // 7 day bonus ‚Üí reset
  if (me.daily.streak === 7) {
    reward += 50;
    me.daily.streak = 0;
    showMessage("üî• 7 Day Streak Bonus +50!", "success");
  }

  me.daily.lastClaim = today;
  me.coins += reward;
  me.balance += coinToRupee(reward);

  users[currentUser] = me;
  setStore("users", users);

  if (firebaseEnabled && db) writeDoc("users", currentUser, me);

  renderHeader();
  showMessage(`+${reward} coins added!`, "success");
}




/* =====================================================
   HISTORY TABLES
===================================================== */
function renderTables() {
  const uid = currentUser;   // üî• ADD THIS LINE

  /* -------- FARMS (only your data) -------- */
  const farms = getStore("farms", []).filter(f => f.owner === uid);   // üî• FIXED
  const ft = document.querySelector("#farmsTable tbody");
ft.innerHTML = farms
  .map(f => {
    return `
      <tr>
        <td>${f.id}</td>
        <td>${f.cropName}</td>
        <td>${f.daysCompleted}/${f.totalDays}</td>
        <td>${f.status}</td>
        <td>‚Çπ${f.earned}</td>
        <td>
          ${f.status !== "completed"
            ? `<button class="btn gold" onclick="claimFarmIncome('${f.id}')">Claim</button>`
            : "Done"}
        </td>
      </tr>
    `;
  })
  .join("");


  /* -------- DEPOSITS (only your data) -------- */
  const deps = getStore("deposits", []).filter(d => d.owner === uid);   // üî• FIXED
  const dt = document.querySelector("#deposTable tbody");
  dt.innerHTML = deps
    .map(
      (d) =>
        `<tr>
          <td>${d.id}</td>
          <td>${formatAmt(d.amount)}</td>
          <td>${d.status}</td>
        </tr>`
    )
    .join("");

  /* -------- WITHDRAWS (only your data) -------- */
  const wds = getStore("withdraws", []).filter(w => w.owner === uid);  // üî• FIXED
  const wt = document.querySelector("#withTable tbody");
  wt.innerHTML = wds
    .map(
      (w) =>
        `<tr>
          <td>${w.id}</td>
          <td>${formatAmt(w.amount)}</td>
          <td>${w.status}</td>
        </tr>`
    )
    .join("");
}


/* =====================================================
   SEARCH
===================================================== */
function filterTables() {
  const q = document.getElementById("searchHistory").value.toLowerCase();
  document.querySelectorAll("#farmsTable tbody tr").forEach((tr) => {
    tr.style.display = tr.innerText.toLowerCase().includes(q) ? "" : "none";
  });
}

/* =====================================================
   SHARE
===================================================== */
function shareApp() {
  navigator.clipboard.writeText(location.origin + "?ref=" + currentUser);
  showMessage("Referral link copied!", "success");
}

/* =====================================================
   FULL REFRESH
===================================================== */
async function fullRefresh() {
  await initialFirestoreSync();   // üî• server ‚Üí local sync

  renderHeader();
  renderProfile();
  renderInventory();
  renderTables();
  showMessage("Refreshed!", "info");
}


/* =====================================================
   FIRESTORE -> Local startup sync (best-effort)
===================================================== */
async function initialFirestoreSync() {
  if (!firebaseEnabled || !db) return;
  try {
    // users
    const usersSnap = await db.collection("users").get();
    const usersMap = {};
    usersSnap.forEach(doc => usersMap[doc.id] = Object.assign({ id: doc.id }, doc.data()));
    if (Object.keys(usersMap).length) setStore("users", usersMap);

    // farms
    const farmsSnap = await db.collection("farms").get();
    const farmsArr = [];
    farmsSnap.forEach(doc => farmsArr.push(Object.assign({ id: doc.id }, doc.data())));
    if (farmsArr.length) setStore("farms", farmsArr);

    // deposits
    const depsSnap = await db.collection("deposits").get();
    const depsArr = [];
    depsSnap.forEach(doc => depsArr.push(Object.assign({ id: doc.id }, doc.data())));
    if (depsArr.length) setStore("deposits", depsArr);

    // withdraws
    const wdsSnap = await db.collection("withdraws").get();
    const wdsArr = [];
    wdsSnap.forEach(doc => wdsArr.push(Object.assign({ id: doc.id }, doc.data())));
    if (wdsArr.length) setStore("withdraws", wdsArr);

    // merge currentUser if available
    const current = getStore("currentUser", null);
    if (current && usersMap[current]) {
      // ensure current user is present
      const allUsers = getStore("users", {});
      allUsers[current] = usersMap[current];
      setStore("users", allUsers);
    }

    console.log("Firestore -> Local sync done");
  } catch (e) {
    console.warn("initialFirestoreSync failed", e);
  }
}
function startUserRealtime() {
    if (!currentUser) return;

    db.collection("users").doc(currentUser)
      .onSnapshot((doc) => {
          if (!doc.exists) return;

          const data = doc.data();

          // Local overwrite
          let u = getStore("users", {});
          u[currentUser] = data;
          setStore("users", u);

          renderHeader();
      });
}

function startFruitPeriodRealtime() {
    db.collection("fruitPeriods")
      .orderBy("startTime", "desc")
      .limit(1)
      .onSnapshot(async (snap) => {

          if (snap.empty) {
              await createNewFruitPeriod();
              return;
          }

          const d = snap.docs[0].data();

          fruitCurrentPeriod = d.period;
          document.getElementById("fruitPeriod").innerText = d.period;

          const nowTime = Date.now();
          fruitTimeLeft = Math.floor((d.endTime - nowTime) / 1000);

          if (fruitTimerInterval) clearInterval(fruitTimerInterval);

          if (fruitTimeLeft <= 0) return;

          startFruitTimer();
      });
}
function startFruitResultRealtime() {
    db.collection("fruitPublicHistory")
      .orderBy("time", "desc")
      .limit(1)
      .onSnapshot((snap) => {
           if (snap.empty) return;

           const d = snap.docs[0].data();

           if (d.period === fruitCurrentPeriod) {
               document.getElementById("fruitResult").innerHTML =
                 "<b>Result:</b> " + d.fruit.toUpperCase();
           }
      });
}
function startDepositRealtime() {
    db.collection("deposits")
      .where("owner", "==", currentUser)
      .onSnapshot((snap) => {
         
          let arr = [];
          snap.forEach(d => arr.push(d.data()));

          // Save to localStorage
          setStore("deposits", arr);

          // Update UI
          renderTables();
      });
}
function startWithdrawRealtime() {
    db.collection("withdraws")
      .where("owner", "==", currentUser)
      .onSnapshot((snap) => {

          let arr = [];
          snap.forEach(d => arr.push(d.data()));

          setStore("withdraws", arr);
          renderTables();
          
          // Refund handler
          arr.forEach(w => {
              if (w.status === "rejected" && !w.refunded) {

                  let usersLocal = getStore("users", {});
                  let me = usersLocal[currentUser];

                  me.balance += w.amount;    // Refund
                  usersLocal[currentUser] = me;
                  setStore("users", usersLocal);

                  // Save back to firebase
                  db.collection("users").doc(currentUser).update(me);
                  db.collection("withdraws").doc(w.id).update({ refunded: true });

                  renderHeader();
                  showMessage("Withdraw Refund Added!", "success");
              }
          });

      });
}


/* =====================================================
   INIT
===================================================== */
async function loadLiveFruitPeriod() {
    if (!firebaseEnabled || !db) {
        console.log("‚ö† Firebase OFF ‚Üí Creating offline period");
        await createNewFruitPeriod();
        return;
    }

    db.collection("fruitPeriods")
      .orderBy("startTime", "desc")
      .limit(1)
      .onSnapshot(async (snap) => {

          // ‚ùå No period in database ‚Üí Always create new
          if (snap.empty) {
              console.log("‚ùå No period found ‚Äî creating NEW");
              await createNewFruitPeriod();
              return;
          }

          const d = snap.docs[0].data();

          fruitCurrentPeriod = d.period;
          document.getElementById("fruitPeriod").innerText = d.period;

          const nowTime = Date.now();
          let end = Number(d.endTime);

          // ‚ùå Invalid timestamp ‚Üí Create new
          if (!end || isNaN(end)) {
              console.log("‚ö† Invalid endTime ‚Äî NEW PERIOD");
              await createNewFruitPeriod();
              return;
          }

          fruitTimeLeft = Math.floor((end - nowTime) / 1000);

          if (fruitTimerInterval) clearInterval(fruitTimerInterval);

          // ‚è≥ Time over ‚Üí New period immediately
          if (fruitTimeLeft <= 0) {
              console.log("‚è≥ Period expired ‚Äî NEW PERIOD");
              await createNewFruitPeriod();
              return;
          }

          startFruitTimer();
      });
}


  // AUTO LOAD PUBLIC & USER FRUIT HISTORY AFTER FIREBASE INIT
setTimeout(() => {
    console.log("‚è≥ Loading Fruit History‚Ä¶");
    loadPublicFruitHistory();
}, 1500);
setTimeout(() => {
    loadFruitBetHistory();   // ‚≠ê load your bet history also
}, 2000);
/* =====================================================
   WATCHDOG ‚Äì GAME NEVER STOPS
===================================================== */
setInterval(() => {
    if (fruitTimeLeft <= 0 && !fruitTimerInterval) {
        console.log("‚õë Auto-recover ‚Üí NEW PERIOD");
        createNewFruitPeriod();
    }
}, 5000);

window.onload = async () => {

    await initialFirestoreSync();

    handleNoticePopup();
    startUserRealtime();
    startDepositRealtime();     // üî• NEW
    startWithdrawRealtime();    // üî• NEW
    startFruitResultRealtime();

    renderHeader();
    renderProfile();
    renderInventory();
    renderTables();

    loadLiveFruitPeriod();
    loadPublicFruitHistory();
    loadFruitBetHistory();
    loadNoticeFromFirestore();
};


function fbWrite(col, id, data) {
    if (!firebaseEnabled || !db) return Promise.resolve();
    return db.collection(col).doc(String(id)).set(data)
      .catch(e => console.warn("Firestore write failed:", e));
}




</script>


<!-- Firebase SDK (optional) -->
<!-- If you want Firebase live features, include these when hosting:-->


</body>
</html>



