<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Farm2Earn ‚Äî Play</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#06060a; --card:#0f1114; --muted:#9aa3b2; --gold:#f6c94b;
  --accent:#7ef2b3; --glass: rgba(255,255,255,0.03);
  --success:#4caf50; --error:#ff6b6b;
}
*{box-sizing:border-box}
body{margin:0; font-family:Inter,system-ui,Arial; background:
  radial-gradient(800px 400px at 10% 10%, rgba(246,201,75,0.04), transparent),
  linear-gradient(180deg,#05050a,#0b0b0d); color:#e9eef8; -webkit-font-smoothing:antialiased}
.app{max-width:1100px;margin:28px auto;padding:18px}
header{display:flex;gap:12px;align-items:center;justify-content:space-between}
.brand{display:flex;gap:12px;align-items:center}
.logo{width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,var(--gold),#ffd86b);display:flex;align-items:center;justify-content:center;color:#111;font-weight:800;font-size:20px;box-shadow:0 8px 30px rgba(246,201,75,0.08)}
h1{margin:0;font-size:18px}
.top-stats{display:flex;gap:10px;align-items:center}
.stat{background:var(--card);padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.02);font-size:13px}
.actions{display:flex;gap:8px;align-items:center}
.btn{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px 12px;border-radius:10px;color:inherit;cursor:pointer}
.btn.gold{background:linear-gradient(90deg,var(--gold),#ffd86b);color:#111;font-weight:700}
.btn.primary{background:linear-gradient(90deg,#7ef2b3,#42d3a2);color:#022; font-weight:700}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:18px;margin-top:22px}
.card{background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);padding:16px;border-radius:14px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 10px 30px rgba(0,0,0,0.6)}
.crop-title{display:flex;align-items:center;gap:12px}
.emoji{font-size:28px}
.small{font-size:13px;color:var(--muted)}
.controls{margin-top:12px;display:flex;gap:8px;align-items:center}
input, select{width:100%;padding:10px;border-radius:8px;border:none;background:#0b0b0f;color:#eaf0ff}
.full{grid-column: span 3}
.footer{margin-top:22px;text-align:center;color:var(--muted);font-size:13px}
.history-list{max-height:260px;overflow:auto;margin-top:12px;border-radius:10px;padding:8px;background:rgba(255,255,255,0.015)}
table{width:100%;border-collapse:collapse;color:#dbe9f7}
th,td{padding:8px;text-align:left;border-bottom:1px dashed rgba(255,255,255,0.03);font-size:13px}
.overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,2,2,0.6);z-index:100}
.popup{width:420px;background:linear-gradient(180deg,#0b0b0d,#0e1114);padding:18px;border-radius:12px;border:1px solid rgba(246,201,75,0.06);box-shadow:0 20px 60px rgba(0,0,0,0.7);text-align:center;position:relative}
.progress{height:12px;background:rgba(255,255,255,0.03);border-radius:8px;overflow:hidden;margin-top:10px}
.progress > i{display:block;height:100%;width:0%;background:linear-gradient(90deg,var(--gold),#ffd86b)}
.qr{display:flex;gap:12px;align-items:center;justify-content:center;margin-top:12px}
.row{display:flex;gap:8px;align-items:center}
@media(max-width:980px){ .grid{grid-template-columns:1fr} .full{grid-column:span 1} .logo{display:none} header{flex-direction:column;align-items:flex-start;gap:8px} }

/* card re-style */
.card{ background:#111; padding:15px; border-radius:12px; color:#fff; margin:10px 0; display:flex; flex-direction:column; gap:10px; }
.controls input{ width:60px; padding:8px; border-radius:6px; border:none; background:#222; color:#fff; }
.btn{ padding:8px 12px; border:none; border-radius:8px; cursor:pointer; font-weight:700; transition:0.18s; }
.btn.gold{ background:var(--gold); color:#000; }
.btn.gold:hover{ filter:brightness(.95); }
.btn.primary{ background:linear-gradient(90deg,#7ef2b3,#42d3a2); color:#022; }
.popup-content{ text-align:left; color:#eaf0ff; }
.popup-close{ position:absolute; right:12px; top:8px; cursor:pointer; color:#fff; font-weight:700; }
.msgBox {
  position: fixed;
  top: -60px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(30, 30, 30, 0.95);
  color: #fff;
  padding: 12px 20px;
  border-radius: 12px;
  font-size: 14px;
  font-weight: 500;
  box-shadow: 0 0 10px rgba(0,0,0,0.4);
  opacity: 0;
  transition: all 0.45s ease;
  z-index: 9999;
}
.msgBox.show {
  top: 25px;
  opacity: 1;
}
.msgBox.success { background: linear-gradient(135deg,#3cd65b,#128d3b); color:#fff; }
.msgBox.error { background: linear-gradient(135deg,#ff5555,#c92a2a); color:#fff; }
.msgBox.info { background: linear-gradient(135deg,#f8d47e,#b89734); color:#111; }
/* === SUCCESS TICK ANIMATION === */
.successTick {
  width: 70px;
  height: 70px;
  border-radius: 50%;
  border: 4px solid #2ecc71;
  display: flex;
  justify-content: center;
  align-items: center;
  margin: 0 auto 10px auto;
  animation: pop 0.3s ease-out forwards;
}

.successTick svg {
  width: 38px;
  height: 38px;
  stroke: #2ecc71;
  stroke-width: 4;
  fill: none;
  stroke-dasharray: 50;
  stroke-dashoffset: 50;
  animation: draw 0.5s ease forwards 0.3s;
}

@keyframes pop {
  0% { transform: scale(0); opacity: 0; }
  80% { transform: scale(1.1); opacity: 1; }
  100% { transform: scale(1); opacity: 1; }
}

@keyframes draw {
  to { stroke-dashoffset: 0; }
}

/* streak bar override color */
.progress > i.streak { background: linear-gradient(90deg,#7ef2b3,#42d3a2); height:100%; display:block; }
.profileBox{
  background:#0e0f14;
  padding:18px;
  border:1px solid rgba(255,255,255,0.06);
  border-radius:14px;
  margin-top:15px;
  box-shadow:0 0 18px rgba(255,215,0,0.05);
}

.heading{
  margin:0 0 12px;
  color:#f6c94b;
  font-size:20px;
  text-align:center;
  font-weight:700;
}

.label{
  display:block;
  margin-top:10px;
  font-size:13px;
  color:#c8cbd1;
}

.in{
  width:100%;
  padding:11px;
  border-radius:10px;
  border:none;
  background:#12131a;
  color:white;
  margin-top:4px;
  font-size:14px;
  outline:none;
  border:1px solid rgba(255,255,255,0.08);
}

.in:focus{
  border:1px solid #f6c94b;
  background:#16171f;
}

.line{
  height:1px;
  width:100%;
  background:rgba(255,255,255,0.05);
  margin:14px 0;
}
</style>
 <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
</head>
<body>

<div class="app">
  <header>
  <div class="brand">
    <div class="logo" style="background:none;box-shadow:none;padding:0">
      <img src="logo.png" style="width:48px;height:48px;border-radius:10px;object-fit:cover;">
    </div>

    <div>
      <h1>Farm2Earn ‚Äî Play</h1>
    </div>
  </div>

  <div class="top-stats">
    <div class="stat">UID: <b id="meId">‚Äî</b></div>
    <div class="stat">Balance: <b id="meBal">‚Çπ0</b></div>
    <div class="stat">Coins: <b id="meCoins">0</b></div>
    <div class="stat">Farms: <b id="meFarms">0</b></div>
    <div class="actions">
      <button class="btn" onclick="fullRefresh()">Refresh</button>
      <button class="btn" id="openAdminHint" title="Admin (hidden)" style="display:none">Admin</button>
    </div>
  </div>
</header>


  <nav style="margin-top:12px">
    <button class="btn" onclick="show('farm')">Farm</button>
    <button class="btn" onclick="show('deposit')">Deposit</button>
    <button class="btn" onclick="show('withdraw')">Withdraw</button>
    <button class="btn" onclick="show('profile')">Profile</button>
    <button class="btn gold" onclick="show('history')">History</button>
  </nav>

  <div id="farm" class="grid">
    <div class="card">
      <div class="crop-title">
        <div class="emoji">üçÖ</div>
        <div>
          <div style="font-weight:700;color:var(--gold)">Tomato ‚Äî Lot (20)</div>
          <div class="small">Cost/lot: ‚Çπ200 ‚Ä¢ Time: 5m</div>
        </div>
      </div>
      <div class="controls">
        <input id="tomatoLots" type="number" min="1" value="1">
        <button class="btn gold" onclick="openFarmPopup('tomato')">Start</button>
      </div>
    </div>

    <div class="card">
      <div class="crop-title">
        <div class="emoji">ü•ï</div>
        <div>
          <div style="font-weight:700;color:var(--gold)">Carrot ‚Äî Lot (15)</div>
          <div class="small">Cost/lot: ‚Çπ150 ‚Ä¢ Time: 5m</div>
        </div>
      </div>
      <div class="controls">
        <input id="carrotLots" type="number" min="1" value="1">
        <button class="btn gold" onclick="openFarmPopup('carrot')">Start</button>
      </div>
    </div>

    <div class="card">
      <div class="crop-title">
        <div class="emoji">ü•î</div>
        <div>
          <div style="font-weight:700;color:var(--gold)">Potato ‚Äî Lot (25)</div>
          <div class="small">Cost/lot: ‚Çπ250 ‚Ä¢ Time: 5m</div>
        </div>
      </div>
      <div class="controls">
        <input id="potatoLots" type="number" min="1" value="1">
        <button class="btn gold" onclick="openFarmPopup('potato')">Start</button>
      </div>
    </div>

    <div class="card full">
      <h3 style="margin:0;color:var(--gold)">Quick Actions</h3>
      <div class="small" style="margin-top:8px">Quick farm, deposit or check history.</div>
      <div style="margin-top:10px" class="row">
        <button class="btn primary" onclick="quickFarm50()">Quick Farm ‚Çπ50</button>
      </div>
    </div>
  </div>

  <!-- deposit -->
  <div id="deposit" class="card full" style="display:none;margin-top:18px">
    <h3 style="color:var(--gold)">üí≥ Deposit (UPI)</h3>
    <div style="margin-top:10px">
      <input id="depositAmt" type="number" min="1" placeholder="Amount (‚Çπ)">

      <select id="depositType" style="margin-top:10px;width:100%;padding:10px;border-radius:8px;background:#0b0b0f;color:#fff">
        <option value="qr">Pay via QR</option>
      </select>

      <button class="btn gold" onclick="startDeposit()" style="margin-top:10px;width:100%">Continue</button>
    </div>

    <div class="small" style="margin-top:10px">You will see a QR + UPI. After paying, press <b>Done</b> to send request to admin.</div>

    <div id="depositFlow" style="display:none;margin-top:12px">
      <div class="small">Send payment to:</div>
      <div style="margin-top:6px;font-weight:700;color:#cfead0" id="upiDisplay"></div>
      <div class="qr" id="qrWrap"></div>
      <div class="small" id="countdownDisplay" style="margin-top:8px"></div>
      <div style="margin-top:10px"><button class="btn gold" id="depositDoneBtn" onclick="finishDeposit()" disabled>Done</button></div>
    </div>
  </div>

  <!-- withdraw -->
 <div id="withdraw" class="card full" style="display:none;margin-top:18px">

    <h3 style="color:var(--gold)">üè¶ Withdraw Money</h3>

    <!-- TYPE SELECTION -->
    <label style="color:#ccc;margin-top:10px;">Select Method</label>
      <select id="withdrawType" class="in" onchange="toggleWithdrawMethod()">
      <option value="upi">UPI</option>
      <option value="bank">Bank Account</option>
      </select>

    <!-- AMOUNT -->
    <input id="withdrawAmt" type="number" class="in" placeholder="Amount (‚Çπ)" style="margin-top:10px">

    <!-- UPI FIELD -->
    <div id="upiBox">
      <input id="withdrawUPI" type="text" class="in" placeholder="Enter UPI ID">
    </div>

    <!-- BANK FIELD -->
    <div id="bankBox" style="display:none;margin-top:10px">
      <div style="background:#111;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.1)">
          <div class="small">Bank Holder: <b id="wbHolder">-</b></div>
          <div class="small">Bank: <b id="wbBank">-</b></div>
          <div class="small">Account: <b id="wbNumber">-</b></div>
          <div class="small">IFSC: <b id="wbIFSC">-</b></div>
          <div class="small">Phone: <b id="wbPhone">-</b></div>
      </div>
    </div>

  <button class="btn gold" onclick="createWithdraw()" style="margin-top:12px">Request Withdraw</button>
 </div>

  <!-- profile -->
  <div id="profile" class="card full" style="display:none;margin-top:18px">
    <h3 style="color:var(--gold)">üë§ Profile</h3>

    <div style="display:flex;align-items:center;gap:15px;margin-top:10px">
      <div style="
        width:60px;height:60px;border-radius:50%;
        background:linear-gradient(135deg,#7ef2b3,#42d3a2);
        display:flex;align-items:center;justify-content:center;
        font-size:24px;font-weight:700;color:#022;
      ">
        <span id="avatarLetter">F</span>
      </div>

      <div style="line-height:1.4">
        <div style="font-size:18px;font-weight:700" id="profileSavedName">‚Äî</div>
        <div class="small">UID: <b id="profileUID">‚Äî</b></div>
        <div class="small">Joined: <b id="joinedDate">‚Äî</b></div>
      </div>
    </div>

  <!-- PROFILE BOX -->
<div class="profileBox">

  <h3 class="heading">üë§ Profile & Bank Details</h3>

  <!-- NAME -->
  <label class="label">Full Name</label>
  <input id="profileName" class="in" placeholder="Your Name">

  <div class="line"></div>

  <!-- BANK HOLDER -->
  <label class="label">Account Holder Name</label>
  <input id="bankHolder" class="in" placeholder="Enter Account Holder Name">

  <!-- BANK NAME -->
  <label class="label">Bank Name</label>
  <input id="bankName" class="in" placeholder="Enter Bank Name">

  <!-- ACCOUNT NUMBER -->
  <label class="label">Account Number</label>
  <input id="bankNumber" class="in" placeholder="Enter Account Number">

  <!-- IFSC -->
  <label class="label">IFSC Code</label>
  <input id="bankIfsc" class="in" placeholder="Enter IFSC Code">

  <!-- PHONE -->
  <label class="label">Phone Number</label>
  <input id="bankPhone" class="in" placeholder="Enter Phone Number">

  <button class="btn gold" onclick="saveProfile()" style="margin-top:10px">Save Details</button>

</div>

    <h4 style="color:var(--gold);margin-top:15px">üî• Daily Streak</h4>
    <div class="small">
      Streak: <b id="streakCount">0</b> / 7
    </div>
    <div class="progress" style="margin-top:6px;height:14px;">
      <i id="streakBar" class="streak" style="width:0%"></i>
    </div>

    <button class="btn primary" onclick="claimDaily()" style="margin-top:12px;width:100%">
      Claim Daily Reward
    </button>

    <h4 style="color:var(--gold);margin-top:15px">üéí Inventory</h4>
    <div id="inventory" class="row"></div>

    <h4 style="color:var(--gold);margin-top:15px">üèÖ Level & Progress</h4>
    <div class="small">Level: <b id="playerLevel">0</b></div>
    <div class="progress"><i id="levelBar" style="width:0%"></i></div>

    <h4 style="color:var(--gold);margin-top:15px">üîó Share & Earn</h4>
<div class="small">Share your link ‚Äî get <b>5 coins</b> per share.</div>

<button class="btn primary" onclick="shareApp()" style="margin-top:10px;width:100%">
  Share & Earn Coins
</button>


<div class="small" style="margin-top:6px">
  Total Shares: <b id="shareCount">0</b><br>
  Level: <b id="shareLevel">0</b>
</div>

<div class="progress" style="margin-top:6px;height:12px;">
  <i id="shareBar" style="width:0%;background:linear-gradient(90deg,#f6c94b,#ffd86b)"></i>
</div>
<button class="btn" onclick="logoutUser()" style="margin-top:10px;width:100%;background:#ff4c4c;color:#fff">
  üö™ Logout
</button>

</div>

  <!-- history -->
  <div id="history" class="card full" style="display:none;margin-top:18px">
    <h3 style="color:var(--gold)">üìú History & Requests</h3>
    <input type="text" id="searchHistory" placeholder="Search farm id / crop..." onkeyup="filterTables()" style="margin-top:8px">
    <div style="margin-top:12px">
      <h4 style="color:var(--gold)">Farms</h4>
      <div style="max-height:220px;overflow:auto"><table id="farmsTable"><thead><tr><th>ID</th><th>Crop</th><th>Lots</th><th>Status</th><th>Profit</th></tr></thead><tbody></tbody></table></div>
      <h4 style="color:var(--gold);margin-top:10px">Deposits</h4>
      <div style="max-height:120px;overflow:auto"><table id="deposTable"><thead><tr><th>ID</th><th>Amt</th><th>Status</th></tr></thead><tbody></tbody></table></div>
      <h4 style="color:var(--gold);margin-top:10px">Withdraws</h4>
      <div style="max-height:120px;overflow:auto"><table id="withTable"><thead><tr><th>ID</th><th>Amt</th><th>Status</th></tr></thead><tbody></tbody></table></div>
    </div>

  <div class="footer">¬© 2025 Farm2Earn ‚Äî stylish demo</div>
</div>

<!-- overlay popup (single shared) -->
<div class="overlay" id="overlayPopup">
  <div class="popup" id="popupBox">
    <span class="popup-close" id="popupClose">‚úñ</span>
    <div class="popup-content">
      <h2 id="popupTitle"></h2>
      <div id="popupBody" style="margin-top:8px"></div>
      <div id="popupProgressWrap" style="display:none;margin-top:12px">
        <div class="progress"><i id="popupProgressBar"></i></div>
      </div>
      <div style="margin-top:12px" id="popupActions"></div>
    </div>
  </div>
</div>

<!-- message container -->
<div id="msgContainer"></div>

<script>
/* =====================================================
   CONFIG
===================================================== */
const firebaseConfig = {
  apiKey: "AIzaSyDQsF4P9UmS0TZArvtvV6e_Fx3pBgNCBaY",
  authDomain: "farm2earning.firebaseapp.com",
  projectId: "farm2earning",
  storageBucket: "farm2earning.firebasestorage.app",
  messagingSenderId: "787325025832",
  appId: "1:787325025832:web:d30236c045fc5f3d7abf1d",
  measurementId: "G-LZYGJEYDQX"
};

// SAVE REFERRAL CODE FROM URL
(function detectReferral() {
  const url = new URLSearchParams(window.location.search);
  const ref = url.get("ref");
  if (ref) {
    localStorage.setItem("referralCode", ref);
    console.log("Referral saved:", ref);
  }
})();


const UPI_ID = "Q424657914@ybl";
const TEST_MODE = false;
const FARM_TIME_MS = TEST_MODE ? 5000 : 5 * 60 * 1000;

/* =====================================================
   FIREBASE INIT
===================================================== */
let firebaseEnabled = false;
let db = null;

function initFirebaseIfAvailable() {
  try {
    if (typeof firebase !== "undefined" && typeof firebase.initializeApp === "function") {
      if (!firebase.apps || firebase.apps.length === 0) {
        firebase.initializeApp(firebaseConfig);
      }
      if (firebase.firestore) {
        db = firebase.firestore();
        firebaseEnabled = true;
        console.log("üî• Firebase Connected");
      }
    }
  } catch (e) {
    console.warn("Firebase init error:", e);
  }
}

(function retryFirebase(attempt = 0) {
  initFirebaseIfAvailable();
  if (!firebaseEnabled && attempt < 8) {
    setTimeout(() => retryFirebase(attempt + 1), 400);
  }
})(0);

function writeDoc(col, id, data) {
  if (!firebaseEnabled || !db) return Promise.resolve();
  return db.collection(col).doc(String(id)).set(data)
    .catch(e => console.warn("Firestore write failed:", e));
}

/* =====================================================
   STORAGE HELPERS
===================================================== */
function getStore(k, def) {
  try {
    const v = JSON.parse(localStorage.getItem(k));
    return v ?? def;
  } catch {
    return def;
  }
}
function setStore(k, v) {
  localStorage.setItem(k, JSON.stringify(v));
}

/* Initialize memory stores */
if (!getStore("users", null)) setStore("users", {});
if (!getStore("farms", null)) setStore("farms", []);
if (!getStore("deposits", null)) setStore("deposits", []);
if (!getStore("withdraws", null)) setStore("withdraws", []);

/* =====================================================
   CURRENT USER
===================================================== */
let users = getStore("users", {});   // GLOBAL users
let currentUser = getStore("currentUser", null);   // ‚≠ê MISSING LINE ADDED

function ensureUser() {
  // Always load fresh users
  users = getStore("users", {});

  let cu = getStore("currentUser", null);

  if (!cu) {
    window.location.href = "login.html";
    return null;
  }

  // If new user ‚Äì create
  if (!users[cu]) {
    users[cu] = {
      id: cu,
      name: "Player",
      balance: 0,
      coins: 0,
      joined: Date.now(),
      stats: { farms: 0, wins: 0, profit: 0 },
      inventory: {},
      daily: { lastClaim: "", streak: 0 },
      bank: null,
      upi: "",
      referredBy: localStorage.getItem("referralCode") || null
    };

    // ‚≠ê MUST SAVE HERE
    setStore("users", users);

    if (firebaseEnabled && db) writeDoc("users", cu, users[cu]);
  }

  return users[cu];
}

if (!currentUser) {
  window.location.href = "login.html";
  throw new Error("Not logged in");
}

/* =====================================================
   UTILITIES
===================================================== */
function randomID() {
  const L = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
  const N = "0123456789";
  return (
    "F2E-" +
    L[Math.floor(Math.random() * L.length)] +
    L[Math.floor(Math.random() * L.length)] +
    L[Math.floor(Math.random() * L.length)] +
    N[Math.floor(Math.random() * N.length)] +
    N[Math.floor(Math.random() * N.length)]
  );
}
function formatAmt(a) {
  return "‚Çπ" + Number(a).toLocaleString("en-IN");
}
function now() {
  return Date.now();
}
function coinToRupee(c) {
  return c / 100;
}

/* =====================================================
   CROP SETTINGS
===================================================== */
const CROP = {
  tomato: { name: "Tomato", lotSize: 20, costPerLot: 200, chance: 3, returnPerItem: 20 },
  carrot: { name: "Carrot", lotSize: 15, costPerLot: 150, chance: 4, returnPerItem: 18 },
  potato: { name: "Potato", lotSize: 25, costPerLot: 250, chance: 2, returnPerItem: 25 }
};

/* =====================================================
   HEADER RENDER
===================================================== */
function renderHeader() {
  let me = ensureUser();
  if (!me) return;

  document.getElementById("meId").innerText = me.id;
  document.getElementById("meBal").innerText = formatAmt(me.balance || 0);
  document.getElementById("meCoins").innerText = me.coins || 0;
  document.getElementById("meFarms").innerText = me.stats?.farms || 0;

  document.getElementById("profileUID").innerText = me.id;
  document.getElementById("profileSavedName").innerText = me.name || "‚Äî";
  document.getElementById("profileName").value = me.name || "";
  document.getElementById("avatarLetter").innerText = (me.name?.[0] || "F").toUpperCase();
document.getElementById("joinedDate").innerText =
  me.joined ? new Date(me.joined).toLocaleDateString() : "‚Äî";

// ‚≠ê ADD THIS BLOCK (BANK DETAILS LOAD)
if (me.bank) {
  document.getElementById("wbHolder").innerText = me.bank.holder;
  document.getElementById("wbBank").innerText = me.bank.bank;
  document.getElementById("wbNumber").innerText = me.bank.number;
  document.getElementById("wbIFSC").innerText = me.bank.ifsc;
  document.getElementById("wbPhone").innerText = me.bank.phone;
}

const streak = me.daily?.streak || 0;
document.getElementById("streakCount").innerText = streak;
document.getElementById("streakBar").style.width = (streak / 7) * 100 + "%";

renderInventory();
renderTables();
}

/* =====================================================
   INVENTORY
===================================================== */
function renderInventory() {
  let me = ensureUser();
  const cont = document.getElementById("inventory");
  cont.innerHTML = "";

  if (!me.inventory || Object.keys(me.inventory).length === 0) {
    cont.innerHTML = "<div class='small'>No items</div>";
    return;
  }

  Object.entries(me.inventory).forEach(([k, v]) => {
    const e = document.createElement("div");
    e.style.padding = "6px 10px";
    e.style.background = "rgba(255,255,255,0.03)";
    e.style.borderRadius = "8px";
    e.innerHTML = `<b>${k}</b> x ${v}`;
    cont.appendChild(e);
  });
}

/* =====================================================
   PAGE SWITCH
===================================================== */
function show(page) {
  ["farm", "deposit", "withdraw", "profile", "history"].forEach((p) => {
    document.getElementById(p).style.display =
      p === page ? (p === "farm" ? "grid" : "block") : "none";
  });

  if (page === "profile") renderProfile();
  if (page === "history") renderTables();
}

/* =====================================================
   POPUPS + TOAST
===================================================== */
function openPopup(title, body, actions = "", showProgress = false) {
  popupTitle.innerText = title;
  popupBody.innerHTML = body;
  popupActions.innerHTML = actions;

  popupProgressWrap.style.display = showProgress ? "block" : "none";
  popupProgressBar.style.width = "0%";

  overlayPopup.style.display = "flex";

  // ‚≠ê CLOSE FIX ‚Äî HAR POPUP KE LIYE
  document.getElementById("popupClose").onclick = closePopup;
}

function closePopup() {
  overlayPopup.style.display = "none";
}
function showMessage(msg, type = "info") {
  const box = document.createElement("div");
  box.className = `msgBox ${type}`;
  box.innerText = msg;
  document.body.appendChild(box);
  setTimeout(() => box.classList.add("show"), 20);
  setTimeout(() => {
    box.classList.remove("show");
    setTimeout(() => box.remove(), 500);
  }, 3000);
}

/* =====================================================
   LOGOUT
===================================================== */
function logoutUser() {
  localStorage.removeItem("currentUser");
  showMessage("Logged out!", "info");
  setTimeout(() => (window.location.href = "login.html"), 600);
}

/* =====================================================
   ****** FARMING (WORKING PERFECT) ******
===================================================== */
function openFarmPopup(cropKey) {
  const crop = CROP[cropKey];
  const lots = Math.max(1, parseInt(document.getElementById(cropKey + "Lots").value) || 1);

  openPopup(
    `Start ${crop.name}`,
    `
    <div><b>${crop.name}</b> ‚Äî ${lots} lot(s)</div>
    <div class='small'>
      Total Qty: <b>${crop.lotSize * lots}</b><br>
      Total Cost: <b>${formatAmt(crop.costPerLot * lots)}</b><br>
      Time: <b>5 minutes</b>
    </div>`,
    `<button class='btn gold' onclick="confirmStartFarm('${cropKey}', ${lots})">Confirm</button>`
  );
}

function confirmStartFarm(cropKey, lots) {
  closePopup();
  startFarm(cropKey, lots);
}

function startFarm(cropKey, lots) {
  let users = getStore("users", {});
  let me = ensureUser();
  const crop = CROP[cropKey];

  const totalCost = crop.costPerLot * lots;
  if (me.balance < totalCost) return showMessage("Insufficient balance!", "error");

  me.balance -= totalCost;
  users[currentUser] = me;
  setStore("users", users);
  if (firebaseEnabled && db) writeDoc("users", currentUser, me);

  const id = randomID();
  const start = now();

  const farm = {
    id,
    owner: currentUser,
    crop: cropKey,
    cropName: crop.name,
    lots,
    lotSize: crop.lotSize,
    cost: totalCost,
    start,
    finish: start + FARM_TIME_MS,
    status: "growing"
  };

  const arr = getStore("farms", []);
  arr.unshift(farm);
  setStore("farms", arr);
  if (firebaseEnabled && db) writeDoc("farms", farm.id, farm);

  renderHeader();
  renderTables();

  openPopup(
    "üåæ Farming Started",
    `<div class='small'>Farm running... ID: <b>${id}</b></div>`,
    `<button class='btn' onclick='closePopup()'>Minimize</button>`,
    true
  );

  let startTS = Date.now();
  let timer = setInterval(() => {
    let pct = Math.min(100, ((Date.now() - startTS) / FARM_TIME_MS) * 100);
    popupProgressBar.style.width = pct + "%";

    if (pct >= 100) {
      clearInterval(timer);
      closePopup();
      settleFarm(id);
    }
  }, 1000);
}

function settleFarm(id) {
  const farms = getStore("farms", []);
  const idx = farms.findIndex((f) => f.id === id);
  if (idx === -1) return;

  const f = farms[idx];
  if (f.status !== "growing") return;

  const cfg = CROP[f.crop];
  let totalWins = 0;
  let perLotWins = [];

  for (let l = 0; l < f.lots; l++) {
    let wins = 0;
    for (let i = 0; i < cfg.lotSize; i++) {
      if (Math.random() * 100 <= cfg.chance) wins++;
    }
    perLotWins.push(wins);
    totalWins += wins;
  }

  const totalReturn = totalWins * cfg.returnPerItem;
  const profit = totalReturn - f.cost;

  // Update farm
  f.status = "finished";
  f.wins = totalWins;
  f.profit = profit;
  f.finishedAt = now();
  farms[idx] = f;
  setStore("farms", farms);
  if (firebaseEnabled && db) writeDoc("farms", f.id, f);

  // Update user
  let users = getStore("users", {});
  let me = users[currentUser];
  me.balance += totalReturn;
  me.stats.farms += 1;
  me.stats.wins += totalWins;
  me.stats.profit += profit;

  users[currentUser] = me;
  setStore("users", users);
  if (firebaseEnabled && db) writeDoc("users", currentUser, me);

  renderHeader();
  renderTables();

  openPopup(
    "üåæ Farming Result",
    `<pre>
Farm ID: ${f.id}
Wins: ${totalWins}
Profit: ${formatAmt(profit)}
</pre>`,
    `<button class='btn gold' onclick='closePopup()'>OK</button>`
  );
}

/* =====================================================
   QUICK FARM
===================================================== */
function quickFarm50() {
  let me = ensureUser();
  if (me.balance < 50) return showMessage("Need ‚Çπ50!", "error");

  me.balance -= 50;
  users[currentUser] = me;
  setStore("users", users);
  if (firebaseEnabled && db) writeDoc("users", currentUser, me);

  const id = randomID();

  const farm = {
    id,
    owner: currentUser,
    crop: "tomato",
    cropName: "Tomato",
    lots: 1,
    lotSize: 5,
    cost: 50,
    start: now(),
    finish: now() + 3000,
    status: "growing"
  };

  const arr = getStore("farms", []);
  arr.unshift(farm);
  setStore("farms", arr);
  if (firebaseEnabled && db) writeDoc("farms", farm.id, farm);

  renderHeader();
  renderTables();

  openPopup("Quick Farm", "Running...", "", true);

  setTimeout(() => settleQuickFarm(id), 3000);
}

function settleQuickFarm(id) {
  const farms = getStore("farms", []);
  const idx = farms.findIndex((f) => f.id === id);
  if (idx === -1) return;

  const f = farms[idx];
  console.log(CROP.tomato)
  let wins = 0;
  for (let i = 0; i < 5; i++) {
  if (Math.random() * 100 <= cfg.chance) wins++;
}


  const totalReturn = wins * cfg.returnPerItem;
  const profit = totalReturn - 50;

  f.wins = wins;
  f.profit = profit;
  f.status = "finished";
  f.finishedAt = now();
  farms[idx] = f;
  setStore("farms", farms);
  if (firebaseEnabled && db) writeDoc("farms", f.id, f);

  let me = ensureUser();
  me.balance += totalReturn;
  me.stats.farms += 1;
  me.stats.wins += wins;
  me.stats.profit += profit;

  users[currentUser] = me;
  setStore("users", users);
  if (firebaseEnabled && db) writeDoc("users", currentUser, me);

  renderHeader();
  renderTables();

  closePopup();
  showMessage(`Quick Profit: ${formatAmt(profit)}`, profit >= 0 ? "success" : "error");
}

/* =====================================================
   DEPOSIT
===================================================== */
function startDeposit() {
  const amt = parseInt(document.getElementById("depositAmt").value) || 0;
  const type = document.getElementById("depositType").value;

  if (amt < 100) return showMessage("Min ‚Çπ100", "error");
  if (amt > 20000) return showMessage("Max ‚Çπ20,000", "error");

  if (type === "qr") depositViaQR(amt);
  else if (type === "phone") depositViaPhoneNumber(amt); // optional
}

/* =====================================================
   QR DEPOSIT (NO MOBILE NUMBER, NO UPI TEXT SHOWN)
===================================================== */
function depositViaQR(amt) {
  const upi = "Q424657914@ybl";

  // UPI Link used in QR + UPI App Opening
  const upiLink = `upi://pay?pa=${upi}&pn=Farm2Earn&am=${amt}&cu=INR`;

  // QR Image
  const qrImg = 
    `https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=${encodeURIComponent(upiLink)}`;

  openPopup(
    "Scan to Pay",
    `
      <div style="text-align:center; margin-bottom:10px;">
        <img src="${qrImg}" 
             width="220" height="220" 
             style="border-radius:12px;">
      </div>

      <div class='small'>Amount: ‚Çπ${amt}</div>

      <div class='small' style="margin-top:10px;">
        If scanning doesn't work, tap below to open UPI App.
      </div>
    `,
    `
      <button class='btn primary' onclick="openUPIApp('${upi}', ${amt})">
        Open UPI App
      </button>
      <button class='btn gold' onclick="finishDeposit(${amt})">
        DONE
      </button>
    `
  );
}

/* =====================================================
   OPEN UPI APP BUTTON FUNCTION
===================================================== */
function openUPIApp(upi, amt) {
  const link = `upi://pay?pa=${upi}&pn=Farm2Earn&am=${amt}&cu=INR`;
  window.location.href = link;
}

/* =====================================================
   FINISH DEPOSIT (SAME AS BEFORE)
===================================================== */
function finishDeposit(amt) {
  closePopup();

  const id = randomID();
  const d = {
    id,
    owner: currentUser,
    amount: amt,
    status: "pending",
    created: now()
  };

  // Save to LocalStorage
  const arr = getStore("deposits", []);
  arr.unshift(d);
  setStore("deposits", arr);

  if (firebaseEnabled && db) writeDoc("deposits", id, d);

  renderTables();
  showMessage("Deposit request submitted!", "success");
}
/* =====================================================
   WITHDRAW
===================================================== */
function toggleWithdrawMethod() {
  const t = document.getElementById("withdrawType").value;

  document.getElementById("upiBox").style.display = t === "upi" ? "block" : "none";
  document.getElementById("bankBox").style.display = t === "bank" ? "block" : "none";

  if (t === "bank") {
    let me = ensureUser();
    if (me.bank) {
      document.getElementById("wbHolder").innerText = me.bank.holder;
      document.getElementById("wbBank").innerText = me.bank.bank;
      document.getElementById("wbNumber").innerText = me.bank.number;
      document.getElementById("wbIFSC").innerText = me.bank.ifsc;
      document.getElementById("wbPhone").innerText = me.bank.phone;
    }
  }
}

function createWithdraw() {
  const amt = parseInt(document.getElementById("withdrawAmt").value) || 0;
  const type = document.getElementById("withdrawType").value;

  let me = ensureUser();

  if (amt < 500) return showMessage("Min ‚Çπ500", "error");
  if (amt > 10000) return showMessage("Max ‚Çπ10,000", "error");
  if (me.balance < amt) return showMessage("Insufficient funds!", "error");

  let note = "";

  if (type === "upi") {
    note = document.getElementById("withdrawUPI").value.trim();
    if (!note) return showMessage("Enter UPI!", "error");
  } else {
    if (!me.bank) return showMessage("Add bank details first!", "error");
    note = `Holder: ${me.bank.holder}, Bank: ${me.bank.bank}, AC: ${me.bank.number}`;
  }

  me.balance -= amt;
  users[currentUser] = me;
  setStore("users", users);
  if (firebaseEnabled && db) writeDoc("users", currentUser, me);

  const id = randomID();
  const w = {
    id,
    owner: currentUser,
    amount: amt,
    method: type,
    note,
    status: "pending",
    created: now()
  };

  const arr = getStore("withdraws", []);
  arr.unshift(w);
  setStore("withdraws", arr);
  if (firebaseEnabled && db) writeDoc("withdraws", id, w);

  renderHeader();
  renderTables();

  openPopup(
    "Withdraw Submitted",
    `
      <div class="successTick">
        <svg viewBox="0 0 52 52">
          <path d="M14 27 l7 7 l17 -17"></path>
        </svg>
      </div>
      <div class="small">Your withdraw request is submitted!</div>
      <div class="small">Amount: ‚Çπ${amt}</div>
    `,
    `<button class='btn gold' onclick='closePopup()'>OK</button>`
  );
}

/* =====================================================
   PROFILE
===================================================== */
function renderProfile() {
  let me = ensureUser();

  document.getElementById("profileName").value = me.name || "";

  if (me.bank) {
    document.getElementById("bankHolder").value = me.bank.holder;
    document.getElementById("bankName").value = me.bank.bank;
    document.getElementById("bankNumber").value = me.bank.number;
    document.getElementById("bankIfsc").value = me.bank.ifsc;
    document.getElementById("bankPhone").value = me.bank.phone;
  }

  if (me.upi) {
    document.getElementById("withdrawUPI").value = me.upi;
  }
}

function saveProfile() {
  let me = ensureUser();

  const name = document.getElementById("profileName").value.trim();
  const holder = document.getElementById("bankHolder").value.trim();
  const bank = document.getElementById("bankName").value.trim();
  const number = document.getElementById("bankNumber").value.trim();
  const ifsc = document.getElementById("bankIfsc").value.trim();
  const phone = document.getElementById("bankPhone").value.trim();

  if (!name) return showMessage("Enter name!", "error");
  if (!holder || !bank || !number || !ifsc || !phone)
    return showMessage("Fill all bank details!", "error");

  me.name = name;
  me.bank = { holder, bank, number, ifsc, phone };

  users[currentUser] = me;
  setStore("users", users);
  users = getStore("users", {});   // ‚≠ê FIX ‚Äì GLOBAL users updated
  if (firebaseEnabled && db) writeDoc("users", currentUser, me);

renderHeader();
showMessage("Profile saved!", "success");

}

/* =====================================================
   DAILY REWARD
===================================================== */
function claimDaily() {
  let me = ensureUser();
  let users = getStore("users", {});  // ‚≠ê FIXED - REQUIRED LINE

  const today = new Date().toDateString();

  if (!me.daily) me.daily = { lastClaim: "", streak: 0 };

  const last = me.daily.lastClaim ? new Date(me.daily.lastClaim).toDateString() : "";

  // Already claimed today
  if (last === today) {
    return showMessage("Already claimed today!", "error");
  }

  // Time gap check
  const lastTime = me.daily.lastClaim ? new Date(me.daily.lastClaim).getTime() : 0;
  const todayTime = new Date(today).getTime();
  const gap = todayTime - lastTime;

  // If gap > 1.5 days ‚Üí reset streak
  if (me.daily.lastClaim && gap > 86400000 * 1.5) {
    me.daily.streak = 0;
  }

  // Increase streak
  me.daily.streak += 1;
  let streak = me.daily.streak;

  // Reward coins
  let reward = 5;

  // 7-day bonus
  if (streak === 7) {
    reward += 50;
    streak = 0;
    me.daily.streak = 0;
    showMessage("üî• 7 Day Streak Bonus +50!", "success");
  }

  // Save new daily data
  me.daily.lastClaim = today;
  me.daily.streak = streak;

  // Add rewards
  me.coins += reward;
  me.balance += coinToRupee(reward);

  // ‚≠ê FIXED: save user correctly
  users[currentUser] = me;
  setStore("users", users);

  if (firebaseEnabled && db) writeDoc("users", currentUser, me);

  renderHeader();
  showMessage(`+${reward} coins added!`, "success");
}



/* =====================================================
   HISTORY TABLES
===================================================== */
function renderTables() {
  const uid = currentUser;   // üî• ADD THIS LINE

  /* -------- FARMS (only your data) -------- */
  const farms = getStore("farms", []).filter(f => f.owner === uid);   // üî• FIXED
  const ft = document.querySelector("#farmsTable tbody");
  ft.innerHTML = farms
    .map(
      (f) =>
        `<tr>
          <td>${f.id}</td>
          <td>${f.cropName}</td>
          <td>${f.lots}</td>
          <td>${f.status}</td>
          <td>${formatAmt(f.profit || 0)}</td>
        </tr>`
    )
    .join("");

  /* -------- DEPOSITS (only your data) -------- */
  const deps = getStore("deposits", []).filter(d => d.owner === uid);   // üî• FIXED
  const dt = document.querySelector("#deposTable tbody");
  dt.innerHTML = deps
    .map(
      (d) =>
        `<tr>
          <td>${d.id}</td>
          <td>${formatAmt(d.amount)}</td>
          <td>${d.status}</td>
        </tr>`
    )
    .join("");

  /* -------- WITHDRAWS (only your data) -------- */
  const wds = getStore("withdraws", []).filter(w => w.owner === uid);  // üî• FIXED
  const wt = document.querySelector("#withTable tbody");
  wt.innerHTML = wds
    .map(
      (w) =>
        `<tr>
          <td>${w.id}</td>
          <td>${formatAmt(w.amount)}</td>
          <td>${w.status}</td>
        </tr>`
    )
    .join("");
}


/* =====================================================
   SEARCH
===================================================== */
function filterTables() {
  const q = document.getElementById("searchHistory").value.toLowerCase();
  document.querySelectorAll("#farmsTable tbody tr").forEach((tr) => {
    tr.style.display = tr.innerText.toLowerCase().includes(q) ? "" : "none";
  });
}

/* =====================================================
   SHARE
===================================================== */
function shareApp() {
  navigator.clipboard.writeText(location.origin + "?ref=" + currentUser);
  showMessage("Referral link copied!", "success");
}

/* =====================================================
   FULL REFRESH
===================================================== */
function fullRefresh() {
  renderHeader();
  renderProfile();
  renderInventory();
  renderTables();
  showMessage("Refreshed!", "info");
}

/* =====================================================
   FIRESTORE -> Local startup sync (best-effort)
===================================================== */
async function initialFirestoreSync() {
  if (!firebaseEnabled || !db) return;
  try {
    // users
    const usersSnap = await db.collection("users").get();
    const usersMap = {};
    usersSnap.forEach(doc => usersMap[doc.id] = Object.assign({ id: doc.id }, doc.data()));
    if (Object.keys(usersMap).length) setStore("users", usersMap);

    // farms
    const farmsSnap = await db.collection("farms").get();
    const farmsArr = [];
    farmsSnap.forEach(doc => farmsArr.push(Object.assign({ id: doc.id }, doc.data())));
    if (farmsArr.length) setStore("farms", farmsArr);

    // deposits
    const depsSnap = await db.collection("deposits").get();
    const depsArr = [];
    depsSnap.forEach(doc => depsArr.push(Object.assign({ id: doc.id }, doc.data())));
    if (depsArr.length) setStore("deposits", depsArr);

    // withdraws
    const wdsSnap = await db.collection("withdraws").get();
    const wdsArr = [];
    wdsSnap.forEach(doc => wdsArr.push(Object.assign({ id: doc.id }, doc.data())));
    if (wdsArr.length) setStore("withdraws", wdsArr);

    // merge currentUser if available
    const current = getStore("currentUser", null);
    if (current && usersMap[current]) {
      // ensure current user is present
      const allUsers = getStore("users", {});
      allUsers[current] = usersMap[current];
      setStore("users", allUsers);
    }

    console.log("Firestore -> Local sync done");
  } catch (e) {
    console.warn("initialFirestoreSync failed", e);
  }
}

/* =====================================================
   INIT
===================================================== */
document.addEventListener("DOMContentLoaded", async () => {
  // try to sync from Firestore on load (best-effort)
  if (firebaseEnabled && db) {
    await initialFirestoreSync();
  }
  renderHeader();
  renderTables();
});
</script>

<!-- Firebase SDK (optional) -->
<!-- If you want Firebase live features, include these when hosting:-->


</body>
</html>


