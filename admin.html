<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Farm2Earn ‚Äî Admin Panel (Fixed)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{--bg:#050507;--card:#0b0b0d;--glass: rgba(255,255,255,0.03);--accent:#f6c94b;--muted:#9aa3b2;--success:#3cd65b;--danger:#ff5b5b;--glass-2: rgba(255,255,255,0.02);--soft-shadow: 0 6px 20px rgba(0,0,0,0.6);}*
  {box-sizing:border-box}body{margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,#030304 0%,#07070a 100%);color:#eaf0ff;min-height:100vh}
  header{position:sticky; top:0; z-index:60;display:flex;align-items:center;justify-content:space-between;gap:12px;padding:14px 20px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);border-bottom:1px solid rgba(255,255,255,0.03);backdrop-filter: blur(6px);} .brand{display:flex;align-items:center;gap:12px}.logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,#111,#0b0b0d);display:flex;align-items:center;justify-content:center;font-weight:900;color:var(--accent);font-size:18px;box-shadow: 0 6px 20px rgba(0,0,0,0.7), inset 0 -6px 18px rgba(0,0,0,0.4)}
  .title{font-weight:800;letter-spacing:0.6px;color:var(--accent);font-size:18px}.header-actions{display:flex;gap:8px;align-items:center}.btn{background:linear-gradient(180deg,#111,#0f0f10);border:1px solid rgba(255,255,255,0.03);color:#fff;padding:8px 10px;border-radius:10px;font-weight:700;cursor:pointer;box-shadow:var(--soft-shadow);}.btn.gold{background:linear-gradient(180deg,#f6d85a,#e6b83e);color:#080707}.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
  .wrap{max-width:1200px;margin:20px auto;padding:16px}.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}.card{background:linear-gradient(180deg,var(--card),#060607);border-radius:14px;padding:16px;border:1px solid var(--glass);box-shadow: 0 10px 30px rgba(0,0,0,0.6);transition:transform .18s ease,box-shadow .18s ease}.card:hover{transform:translateY(-6px);box-shadow:0 16px 40px rgba(0,0,0,0.75)}h3{margin:0 0 10px 0;color:var(--accent);font-size:16px}.small{font-size:13px;color:var(--muted)}.stat-row{display:flex;gap:18px;align-items:center;justify-content:space-between}.stat{background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);padding:12px;border-radius:10px;min-width:120px;text-align:center}.stat .num{font-size:20px;font-weight:800}
  .table-wrap{overflow:auto;border-radius:10px;border:1px solid var(--glass-2);margin-top:10px}table{width:100%;border-collapse:collapse;color:#e8f3ff;font-size:14px}th,td{padding:12px 10px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.02)}thead th{color:var(--muted);font-weight:700;font-size:13px}tbody tr:hover{background:linear-gradient(90deg,rgba(255,255,255,0.01),transparent)}.badge{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:800}.status.pending{background:#f7e2a7;color:#111}.status.approved{background:var(--success);color:#111}.status.rejected{background:var(--danger);color:#111}.btn-small{padding:6px 8px;border-radius:8px;font-size:13px}
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(0,0,0,0.7),rgba(0,0,0,0.7));z-index:200;padding:20px}.modal .box{background:linear-gradient(180deg,#0a0a0c,#060607);padding:18px;border-radius:14px;width:100%;max-width:880px;border:1px solid rgba(255,255,255,0.03);max-height:88vh;overflow:auto}.search{padding:10px;border-radius:10px;border:none;background:#0f0f11;color:#fff;min-width:220px}@media(max-width:980px){ .grid{grid-template-columns:1fr} .stat-row{flex-direction:column;align-items:flex-start} .search{width:100%}}.loader-wrap{position:fixed;left:0;top:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;z-index:300;background:rgba(0,0,0,0.5)}.loader{width:110px;height:110px;border-radius:18px;background:linear-gradient(180deg,#0b0b0d,#060607);display:flex;align-items:center;justify-content:center;flex-direction:column;color:var(--muted);box-shadow:0 14px 40px rgba(0,0,0,0.7)}.spinner{width:48px;height:48px;border-radius:50%;border:5px solid rgba(255,255,255,0.06);border-top-color:var(--accent);animation:spin 1s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>

<header>
  <div class="brand">
    <div class="logo">F2E</div>
    <div>
      <div class="title">Farm2Earn ‚Ä¢ ADMIN</div>
      <div class="small muted">Full Control Panel ‚Äî Premium</div>
    </div>
  </div>

  <div class="header-actions">
    <div class="pill" id="firebaseState">Firebase: initializing‚Ä¶</div>
    <button class="btn ghost" onclick="openHelp()">Help</button>
    <button class="btn" id="refreshBtn" onclick="proRefresh()">‚ü≥ REFRESH</button>
    <button class="btn gold" onclick="logoutAdmin()">LOGOUT</button>
  </div>
</header>

<div class="wrap">
  <!-- LOGIN -->
  <div id="loginBox" class="card" style="max-width:640px;margin:18px auto">
    <h3 style="color:var(--accent)">Admin Login</h3>
    <div class="small">Enter admin password to continue</div>
    <div style="margin-top:14px;display:flex;gap:8px;align-items:center">
      <input id="adminPass" class="search" type="password" placeholder="Admin password" />
      <button id="loginBtn" class="btn gold" onclick="loginAdmin()">Login</button>
    </div>
    <div id="loginErr" class="small" style="color:var(--danger);display:none;margin-top:8px">Wrong password</div>
    <div class="small muted" style="margin-top:8px">First run default password: <b>admin123</b>. Change it in Admin Settings after login.</div>
  </div>

  <!-- PANEL -->
  <div id="panel" style="display:none">

    <!-- TOP STATS -->
    <div class="grid">
      <div class="card">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <h3>Dashboard</h3>
          <div class="small muted">Realtime: <span id="realtimeHint">initializing</span></div>
        </div>
        <div style="margin-top:12px" class="stat-row">
          <div class="stat"><div class="small muted">Total Users</div><div class="num" id="statUsers">0</div></div>
          <div class="stat"><div class="small muted">Total Deposits</div><div class="num" id="statDepos">‚Çπ0</div></div>
          <div class="stat"><div class="small muted">Total Withdraws</div><div class="num" id="statWith">‚Çπ0</div></div>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
          <div class="small muted">Pending Deposits: <b id="statPendingDep">0</b></div>
          <div class="small muted">Pending Withdraws: <b id="statPendingWith">0</b></div>
          <div class="small muted">Growing Farms: <b id="statPendingFarms">0</b></div>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
          <button class="btn" onclick="recalcAllStats()">Recalc</button>
          <button class="btn ghost" onclick="backupAll()">Backup</button>
        </div>
      </div>

      <!-- ADMIN SETTINGS -->
      <div class="card">
        <h3>Admin Settings</h3>
        <div class="small muted">Global farm control</div>
        <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
          <select id="globalForceMode" style="padding:8px;border-radius:10px;background:#0b0b0d;color:#fff;border:1px solid rgba(255,255,255,0.03)">
            <option value="normal">Normal (random)</option>
            <option value="force-win">Force Win</option>
            <option value="force-lose">Force Lose</option>
          </select>
          <button class="btn" onclick="saveAdminSettings()">Save</button>
          <button class="btn ghost" onclick="resetAdminSettings()">Reset</button>
        </div>

        <div style="margin-top:14px">
          <div class="small muted">Change Admin Password</div>
          <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
            <input id="newAdminPass" class="search" placeholder="New admin password" />
            <button class="btn" onclick="changeAdminPassword()">Change</button>
          </div>
        </div>
      
        <div style="margin-top:12px">
          <div class="small muted">Export</div>
          <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn ghost" onclick="exportCSV('users')">Users CSV</button>
            <button class="btn ghost" onclick="exportCSV('deposits')">Deposits CSV</button>
            <button class="btn ghost" onclick="exportCSV('withdraws')">Withdraws CSV</button>
            <button class="btn ghost" onclick="exportCSV('farms')">Farms CSV</button>
            <button class="btn ghost" onclick="exportCSV('adminLogs')">Logs CSV</button>
          </div>
        </div>
      </div>

      <!-- QUICK ACTIONS -->
      <div class="card">
        <h3>Quick Actions</h3>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
          <button class="btn gold" onclick="recalcAllStats()">Recalc Stats</button>
          <button class="btn" onclick="clearAllLogs()">Clear Logs</button>
          <button class="btn" onclick="purgeTestData()">Purge Test Data</button>
        </div>
        <div style="margin-top:12px" class="small muted">Activity logs capture admin operations.</div>
      </div>
    </div>
      <!-- GLOBAL NOTICE SYSTEM -->
<div class="card" style="margin-top:16px">
  <h3>Global Notice</h3>
  <div class="small muted">This notice will be shown to all users</div>

  <textarea id="noticeText" class="search" 
            rows="3" placeholder="Enter notice text..."></textarea>

  <div style="margin-top:10px; display:flex; gap:8px">
    <button class="btn gold" onclick="saveNotice()">Publish</button>
    <button class="btn ghost" onclick="clearNotice()">Clear</button>
  </div>
</div>

    <!-- USERS / DEPOSITS / WITHDRAWS -->
    <div class="grid" style="margin-top:16px">
      <div class="card" style="min-height:360px">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <h3>Users</h3>
          <div style="display:flex;gap:8px;align-items:center">
            <input id="userSearch" class="search" placeholder="Search UID or name" oninput="renderUsers()" />
            <button class="btn" onclick="openAddBalanceModal()">Adjust Balance</button>
          </div>
        </div>
        <div class="table-wrap" style="margin-top:10px;max-height:300px;overflow:auto">
          <table id="usersTbl"><thead><tr><th>UID</th><th>Name</th><th>Phone</th><th>Balance</th><th>Farms</th><th>Susp.</th><th>Action</th></tr></thead><tbody></tbody></table>
        </div>
      </div>

      <div class="card">
        <h3>Deposits</h3>
        <div class="table-wrap" style="margin-top:10px;max-height:360px;overflow:auto"><table id="deposTbl"><thead><tr><th>ID</th><th>UID</th><th>Amt</th><th>Status</th><th>Action</th></tr></thead><tbody></tbody></table></div>
      </div>

      <div class="card">
        <h3>Withdraws</h3>
        <div class="table-wrap" style="margin-top:10px;max-height:360px;overflow:auto"><table id="withTbl"><thead><tr><th>ID</th><th>UID</th><th>Amt</th><th>Note</th><th>Status</th><th>Action</th></tr></thead><tbody></tbody></table></div>
      </div>
    </div>
   <h4 style="margin-top:10px;color:var(--accent)">Set Result</h4>

<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px">
  <button class="btn-small force-btn" onclick="forceFruit('apple')">üçé Apple</button>
  <button class="btn-small force-btn" onclick="forceFruit('banana')">üçå Banana</button>
  <button class="btn-small force-btn" onclick="forceFruit('mango')">ü•≠ Mango</button>
  <button class="btn-small force-btn" onclick="forceFruit('grapes')">üçá Grapes</button>
  <button class="btn-small force-btn" onclick="forceFruit('avocado')">ü•ë Avocado</button>
  <button class="btn-small force-btn" onclick="forceFruit('orange')">üçä Orange</button>
</div>

<h4 style="margin-top:10px;color:var(--accent)">Auto Mode (Profit)</h4>
<button class="btn-small" 
        style="background:#3cd65b;color:#111;font-weight:700;margin-bottom:12px"
        onclick="autoPickWinner()">
  AUTO PICK WIN (Profit Mode)
</button>

<h4 style="margin-top:10px;color:var(--accent)">Return Multiplier</h4>

<div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px">
  <button class="btn-small" onclick="setMultiplier(1.5)">1.5x</button>
  <button class="btn-small" onclick="setMultiplier(2)">2x</button>
  <button class="btn-small" onclick="setMultiplier(3)">3x</button>
  <button class="btn-small" onclick="setMultiplier(5)">5x</button>

  <input id="customMultiplier" class="search" 
         placeholder="Custom X" 
         style="width:100px;border-radius:8px;padding:6px 8px" />

  <button class="btn-small gold" onclick="setCustomMultiplier()">SET</button>
</div>

<div class="small muted" style="margin-top:6px;margin-bottom:10px">
  Current Multiplier: <b id="currentMultiplier">2x</b>
</div>

    <!-- FARMS -->
    <div class="card" style="margin-top:16px">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <h3>Farms (Pending / Growing)</h3>
        <div class="small muted">Force settle farms or let them finish normally.</div>
      </div>
      <div class="table-wrap" style="margin-top:10px;max-height:360px;overflow:auto"><table id="farmsTbl"><thead><tr><th>ID</th><th>UID</th><th>Crop</th><th>Lots</th><th>Cost</th><th>Status</th><th>Action</th></tr></thead><tbody></tbody></table></div>
    </div>

    <!-- LOGS -->
    <div class="card" style="margin-top:12px"><h3>Admin Activity Logs</h3><div class="table-wrap" style="margin-top:8px;max-height:260px;overflow:auto"><table id="logsTbl"><thead><tr><th>Time</th><th>Action</th><th>Details</th></tr></thead><tbody></tbody></table></div></div>

  </div>
</div>

<!-- Modal -->
<div id="modal" class="modal"><div class="box" id="modalBox"></div></div>

<!-- Loader / Refresh overlay -->
<div id="loaderWrap" class="loader-wrap"><div class="loader"><div class="spinner"></div><div style="margin-top:10px;color:var(--muted)">Refreshing data‚Ä¶</div></div></div>

<!-- Firebase compat scripts (stable) -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
/* ====== firebase config (your project) ====== */
const firebaseConfig = {
  apiKey: "AIzaSyDQsF4P9UmS0TZArvtvV6e_Fx3pBgNCBaY",
  authDomain: "farm2earning.firebaseapp.com",
  projectId: "farm2earning",
  storageBucket: "farm2earning.firebasestorage.app",
  messagingSenderId: "787325025832",
  appId: "1:787325025832:web:d30236c045fc5f3d7abf1d"
};
// GLOBAL crop settings (REQUIRED)
const cfgs = {
  tomato: { lotSize: 20, returnPerItem: 20 },
  carrot: { lotSize: 15, returnPerItem: 18 },
  potato: { lotSize: 25, returnPerItem: 25 }
};

let firebaseEnabled = false;
let db = null;

// initialise firebase a little after scripts load to avoid timing issues
function tryInitFirebase(){
  try{
    if(typeof firebase !== 'undefined' && typeof firebase.firestore !== 'undefined'){
      // If already initialised, avoid re-init
      if(!firebase.apps || (firebase.apps && firebase.apps.length===0)){
        firebase.initializeApp(firebaseConfig);
      }
      db = firebase.firestore();
      firebaseEnabled = true;
      document.getElementById('firebaseState').innerText = 'Firebase: enabled';
      document.getElementById('realtimeHint').innerText = 'local + firestore';
      addLog('firebase-init','enabled');
      console.log('Firebase enabled');
    } else {
      document.getElementById('firebaseState').innerText = 'Firebase: disabled';
      console.warn('Firebase SDK not found');
    }
  }catch(e){
    console.warn('Firebase init failed', e);
    document.getElementById('firebaseState').innerText = 'Firebase: error';
    firebaseEnabled = false;
  }
}
// small delay so SDK finishes loading in slow environments
setTimeout(tryInitFirebase, 800);

/* ====== localStorage helpers (safe) ====== */
function getStore(k, def){ try{ const v = JSON.parse(localStorage.getItem(k)); return v ?? def; }catch(e){ return def; } }
function setStore(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(e){ console.warn('setStore err', e); } }

/* Only create empty defaults if key is totally missing (null/undefined) ‚Äî do not overwrite existing data */
if(getStore('users', undefined) === undefined) setStore('users', {});
if(getStore('deposits', undefined) === undefined) setStore('deposits', []);
if(getStore('withdraws', undefined) === undefined) setStore('withdraws', []);
if(getStore('farms', undefined) === undefined) setStore('farms', []);
if(getStore('adminLogs', undefined) === undefined) setStore('adminLogs', []);
if(getStore('adminSettings', undefined) === undefined) setStore('adminSettings', {globalForceMode:'normal'});

/* admin pass default only if absent */
if(localStorage.getItem('adminPassword') === null) localStorage.setItem('adminPassword','admin123');

/* utils */
function now(){ return Date.now(); }
function fmtTime(ts){ const d=new Date(ts); return d.toLocaleString(); }
function addLog(action, details=''){ const logs = getStore('adminLogs',[]); const entry={t:now(),action,details}; logs.unshift(entry); setStore('adminLogs',logs); if(firebaseEnabled && db){ try{ db.collection('adminLogs').doc(String(entry.t)).set(entry); }catch(e){ console.warn('log write failed', e); } } renderLogs(); }
function formatINR(a){ const n=Number(a||0); if(isNaN(n)) return '‚Çπ0'; return '‚Çπ'+n.toLocaleString('en-IN'); }
function randomID(){ const L='ABCDEFGHIJKLMNOPQRSTUVWXYZ', N='0123456789'; let s=''; for(let i=0;i<3;i++) s+=L[Math.floor(Math.random()*L.length)]; for(let j=0;j<2;j++) s+=N[Math.floor(Math.random()*N.length)]; return 'F2E-'+s; }

/* ====== LOGIN ====== */
function loginAdmin(){
  const v = document.getElementById('adminPass').value.trim();
  const stored = localStorage.getItem('adminPassword') || 'admin123';
  if(v === stored){
    document.getElementById('loginBox').style.display='none';
    document.getElementById('panel').style.display='block';
    // fetch live data from firestore (if available) then load panel
    if(firebaseEnabled && db){
      showLoader();
      fetchFromFirestore().then(()=>{
        hideLoader();
        loadPanel();
        addLog('login','admin');
      }).catch(err=>{
        hideLoader();
        console.warn('fetchFromFirestore failed on login', err);
        // still load using localStorage
        loadPanel();
        addLog('login-local','admin');
      });
    } else {
      loadPanel();
      addLog('login-local','admin');
    }
  } else {
    document.getElementById('loginErr').style.display='block';
    addLog('failed-login','attempt');
  }
}
document.getElementById('adminPass').addEventListener('input',()=>document.getElementById('loginErr').style.display='none');
function logoutAdmin(){ if(!confirm('Logout admin?')) return; document.getElementById('panel').style.display='none'; document.getElementById('loginBox').style.display='block'; document.getElementById('adminPass').value=''; addLog('logout','admin'); }

/* ====== RENDER / PANEL ====== */
function loadPanel(){ renderUsers(); renderDeposits(); renderWithdraws(); renderFarms(); renderLogs(); loadAdminSettingsToUI(); recalcAllStats(); }
async function loadFruitStats() {
  const period = getStore("lastFruitPeriod", "‚Äî");
  document.getElementById("fcPeriod").innerText = period;

  if (!firebaseEnabled || !db) return alert("Firebase disabled!");

  const snap = await db.collection("fruitBets")
      .where("period", "==", period)
      .get();

  let stats = {
    apple: 0, banana: 0, mango: 0,
    grapes: 0, avocado: 0, orange: 0
  };

  snap.forEach(doc => {
    const d = doc.data();
    stats[d.fruit] += d.total;
  });

  let html = "";
  for (let f in stats) {
    html += `${f.toUpperCase()}: ‚Çπ${stats[f]}<br>`;
  }

  document.getElementById("fruitStats").innerHTML = html;
}
function forceFruit(fruitName) {
  const period = getStore("lastFruitPeriod", null);
  if (!period) return alert("No active period!");

  if (!firebaseEnabled || !db)
    return alert("Firebase disabled!");

  db.collection("forceFruitResult")
    .doc(period)
    .get()
    .then(doc => {

      // ‚ùó ALREADY SET ‚Üí BLOCK
      if (doc.exists) {
        alert("Result already locked for this period!");
        return;
      }

      // SET ONCE ONLY
      return db.collection("forceFruitResult")
        .doc(period)
        .set({
          period: period,
          fruit: fruitName,
          forced: true,
          locked: true,
          time: Date.now()
        })
        .then(() => {
          alert("WIN LOCKED: " + fruitName.toUpperCase());
        });

    });
}

function autoPickWinner() {
    const period = getStore("lastFruitPeriod", null);
    if (!period) return alert("No active period!");

    if (!firebaseEnabled || !db)
        return alert("Firebase disabled!");

    // Step 1: Read all bets for current period
    db.collection("fruitBets")
        .where("period", "==", period)
        .get()
        .then(snap => {
            let stats = {
                apple: 0, banana: 0, mango: 0,
                grapes: 0, avocado: 0, orange: 0
            };

            snap.forEach(doc => {
                const d = doc.data();
                stats[d.fruit] += d.total;
            });

            // Step 2: MINIMUM bet = WINNER
            let minBet = Infinity;
            let winner = "apple";

            for (let f in stats) {
                if (stats[f] < minBet) {
                    minBet = stats[f];
                    winner = f;
                }
            }

            // Step 3: lock result
            db.collection("forceFruitResult")
                .doc(period)
                .set({
                    period: period,
                    fruit: winner,
                    forced: true,
                    auto: true,
                    time: Date.now()
                })
                .then(() => {
                    alert("AUTO WIN (Lowest Bet) ‚Üí " + winner.toUpperCase());
                    disableFruitButtons();
                });
        });
}
// Default multiplier
if (!getStore("fruitMultiplier", null)) {
    setStore("fruitMultiplier", 2);
}

function setMultiplier(x) {
    setStore("fruitMultiplier", x);
    document.getElementById("currentMultiplier").innerText = x + "x";
    alert("Multiplier Updated ‚Üí " + x + "x");
}

function setCustomMultiplier() {
    let v = parseFloat(document.getElementById("customMultiplier").value);
    if (isNaN(v) || v <= 0) {
        return alert("Enter valid multiplier");
    }
    setStore("fruitMultiplier", v);
    document.getElementById("currentMultiplier").innerText = v + "x";
    alert("Custom Multiplier Set ‚Üí " + v + "x");
}

/* USERS */
function renderUsers(){ const q=(document.getElementById('userSearch')?.value||'').trim().toLowerCase(); const usersObj=getStore('users',{}); const tbody=document.querySelector('#usersTbl tbody'); tbody.innerHTML=''; Object.keys(usersObj).forEach(k=>{ const u = usersObj[k]; if(!u) return; if(!u.id) u.id = k; if(q && !(u.id.toLowerCase().includes(q) || (u.name||'').toLowerCase().includes(q))) return; const tr=document.createElement('tr'); tr.innerHTML = `\n  <td>${u.id}</td>\n  <td>${u.name || '‚Äî'}</td>\n  <td>${u.phone || '‚Äî'}</td>   \n  <td>${formatINR(u.balance || 0)}</td>\n  <td>${u.stats?.farms || 0}</td>\n  <td>${u.suspended ? 'Y' : 'N'}</td>\n      <td>\n        <button class="btn-small" onclick="openUserDetail('${u.id}')">View</button>\n        <button class="btn-small" onclick="toggleSuspend('${u.id}')">${u.suspended? 'Unsus' : 'Suspend'}</button>\n        <button class="btn-small" onclick="openAddBalanceModal('${u.id}')">Adj</button>\n      </td>`; tbody.appendChild(tr); }); }
function toggleSuspend(uid){ const users=getStore('users',{}); if(!users[uid]) return alert('User not found'); users[uid].suspended = !users[uid].suspended; setStore('users',users); if(firebaseEnabled && db) writeUser(uid,users[uid]); addLog(users[uid].suspended? 'suspend' : 'unsuspend', uid); renderUsers(); recalcAllStats(); }

/* Adjust balance modal */
function openAddBalanceModal(uid=null){ const users=getStore('users',{}); const defaultUID = uid || Object.keys(users)[0] || ''; const html = `<h3>Adjust Balance</h3>\n    <div class="small muted">Positive to add, negative to remove</div>\n    <div style="margin-top:12px" class="col">\n      <label class="small muted">UID</label><input id="adjUID" class="search" value="${defaultUID}" />\n      <label class="small muted">Amount</label><input id="adjAmt" class="search" placeholder="e.g. 500 or -200" />\n      <label class="small muted">Reason</label><input id="adjReason" class="search" placeholder="Reason" />\n      <div style="margin-top:8px;display:flex;gap:8px"><button class="btn gold" onclick="applyAdjustBalance()">Apply</button><button class="btn ghost" onclick="closeModal()">Cancel</button></div>\n    </div>`; showModal(html); }
function applyAdjustBalance(){ const uid=document.getElementById('adjUID').value.trim(); const amt=Number(document.getElementById('adjAmt').value||0); const reason=(document.getElementById('adjReason').value||'').trim(); if(!uid) return alert('Enter UID'); const users=getStore('users',{}); if(!users[uid]) return alert('User not found'); users[uid].balance = Number(users[uid].balance||0) + amt; setStore('users',users); if(firebaseEnabled && db) writeUser(uid,users[uid]); addLog('adjust-balance', `${uid} ${amt} (${reason})`); closeModal(); renderUsers(); recalcAllStats(); }

/* DEPOSITS */
function renderDeposits() {
  const deps = getStore("deposits", []);
  const tbody = document.querySelector("#deposTbl tbody");
  tbody.innerHTML = "";

  deps.forEach(d => {
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${d.id}</td>
      <td>${d.owner}</td>
      <td>${formatINR(d.amount)}</td>

      <td>
        ${d.screenshot 
          ? `<img src="${d.screenshot}" 
                   style="width:60px;border-radius:6px;cursor:pointer"
                   onclick="viewImage('${d.screenshot}')">`
          : "‚Äî"}
      </td>

      <td>
        <span class="badge status ${d.status}">${d.status}</span>
      </td>

      <td>
        ${
          d.status === "pending"
            ? `<button class="btn-small" onclick="approveDeposit('${d.id}')">Approve</button>
               <button class="btn-small" onclick="rejectDeposit('${d.id}')">Reject</button>`
            : "‚Äî"
        }
      </td>
    `;

    tbody.appendChild(tr);
  });
}
function viewImage(src) {
  showModal(`
    <h3>Payment Screenshot</h3>
    <img src="${src}" 
         style="width:100%;border-radius:12px;margin-top:10px">
    <div style="margin-top:12px;">
      <button class="btn gold" onclick="closeModal()">Close</button>
    </div>
  `);
}

async function approveDeposit(id){ if(!confirm('Approve deposit '+id+'?')) return; const deps=getStore('deposits',[]); const idx=deps.findIndex(x=>x.id===id); if(idx===-1) return alert('Not found'); const d=deps[idx]; if(d.status!=='pending') return alert('Already processed'); const users=getStore('users',{}); if(!users[d.owner]) return alert('User not found'); users[d.owner].balance = Number(users[d.owner].balance||0)+Number(d.amount); d.status='approved'; setStore('deposits',deps); setStore('users',users); if(firebaseEnabled && db){ try{ await writeUser(d.owner,users[d.owner]); await writeDoc('deposits', id, d); }catch(e){ console.warn('approveDeposit firebase write failed', e); } } addLog('approve-deposit', `${id} ${d.owner}`); renderDeposits(); renderUsers(); recalcAllStats(); }
async function rejectDeposit(id){ if(!confirm('Reject deposit '+id+'?')) return; const deps=getStore('deposits',[]); const idx=deps.findIndex(x=>x.id===id); if(idx===-1) return; deps[idx].status='rejected'; setStore('deposits',deps); if(firebaseEnabled && db) try{ await writeDoc('deposits', id, deps[idx]); }catch(e){ console.warn('rejectDeposit firebase write failed', e); } addLog('reject-deposit', id); renderDeposits(); recalcAllStats(); }
/* ==========================
      NOTICE SYSTEM
========================== */
async function saveNotice() {
  const text = document.getElementById("noticeText").value.trim();
  if (!text) return alert("Enter notice");

  await db.collection("notices").doc("global").set({
    text: text,
    ts: Date.now()
  });

  addLog("notice-update", text);
  alert("Notice published!");
}

async function clearNotice() {
  await db.collection("notices").doc("global").delete();
  document.getElementById("noticeText").value = "";
  
  addLog("notice-clear", "");
  alert("Notice cleared!");
}
function disableFruitButtons() {
  document.querySelectorAll(".force-btn").forEach(btn => {
    btn.disabled = true;
    btn.style.opacity = "0.5";
  });
}

/* WITHDRAWS */
function renderWithdraws(){ const wds=getStore('withdraws',[]); const tbody=document.querySelector('#withTbl tbody'); tbody.innerHTML=''; wds.forEach(w=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${w.id}</td><td>${w.owner}</td><td>${formatINR(w.amount)}</td><td>${w.note||'‚Äî'}</td><td><span class="badge status ${w.status}">${w.status}</span></td>\n    <td>${w.status==='pending'? `<button class="btn-small" onclick="approveWithdraw('${w.id}')">Approve</button> <button class="btn-small" onclick="rejectWithdraw('${w.id}')">Reject</button>`:'‚Äî'}</td>`; tbody.appendChild(tr); }); }
async function approveWithdraw(id){ if(!confirm('Approve withdraw '+id+'? Ensure payout externally.')) return; const wds=getStore('withdraws',[]); const idx=wds.findIndex(x=>x.id===id); if(idx===-1) return; wds[idx].status='approved'; setStore('withdraws',wds); if(firebaseEnabled && db) try{ await writeDoc('withdraws', id, wds[idx]); }catch(e){ console.warn('approveWithdraw firebase write failed', e); } addLog('approve-withdraw', id); renderWithdraws(); recalcAllStats(); }
async function rejectWithdraw(id){ if(!confirm('Reject withdraw '+id+' and refund?')) return; const wds=getStore('withdraws',[]); const idx=wds.findIndex(x=>x.id===id); if(idx===-1) return; const w=wds[idx]; const users=getStore('users',{}); if(users[w.owner]){ users[w.owner].balance = Number(users[w.owner].balance||0) + Number(w.amount); setStore('users', users); if(firebaseEnabled && db) try{ await writeUser(w.owner, users[w.owner]); }catch(e){ console.warn('rejectWithdraw writeUser failed', e); } } w.status='rejected'; setStore('withdraws', wds); if(firebaseEnabled && db) try{ await writeDoc('withdraws', id, w); }catch(e){ console.warn('rejectWithdraw writeDoc failed', e); } addLog('reject-withdraw', `${id} refunded ${w.owner}`); renderWithdraws(); renderUsers(); recalcAllStats(); }

/* FARMS */
function forceWinFarm(farmId, win, profit) {
    const farms = getStore("farms", []);
    const idx = farms.findIndex(f => f.id === farmId);
    if (idx === -1) return;

    let f = farms[idx];

    f.adminForced = true;
    f.status = "finished";
    f.wins = win;
    f.profit = profit;
    f.finishedAt = now();

    farms[idx] = f;
    setStore("farms", farms);

    if (firebaseEnabled && db) 
        writeDoc("farms", f.id, f);

    // update user balance
    const users = getStore("users", {});
    if(users[f.owner]){
    const totalReturn = profit + f.cost;  // same logic as player
    users[f.owner].balance = Number(users[f.owner].balance || 0) + (totalReturn < 0 ? 0 : totalReturn);
        setStore("users", users);
        if(firebaseEnabled && db) writeUser(f.owner, users[f.owner]);
    }

    addLog("force-winloss", farmId);
    renderFarms();
    renderUsers();
    recalcAllStats();

    alert("Forced win/loss applied successfully!");
}


function renderFarms(){ const farms=getStore('farms',[]); const tbody=document.querySelector('#farmsTbl tbody'); tbody.innerHTML=''; farms.forEach(f=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${f.id}</td><td>${f.owner}</td><td>${f.cropName||f.crop}</td><td>${f.lots}</td><td>${formatINR(f.cost)}</td><td>${f.status}</td>\n    <td>${f.status==='growing'? `
<button class="btn-small" onclick="forceWinFarm('${f.id}', f.lots * (cfgs[f.crop]?.lotSize || 20), ((f.lots * (cfgs[f.crop]?.lotSize || 20)) * (cfgs[f.crop]?.returnPerItem || 20)) - f.cost)">Force Win</button>
<button class="btn-small" onclick="forceWinFarm('${f.id}', 0, -f.cost)">Force Lose</button>
<button class="btn-small" onclick="forceSettleFarm('${f.id}','normal')">Settle</button>`:'‚Äî'}</td>`; tbody.appendChild(tr); }); }
function forceSettleFarm(id,mode='normal'){ if(!confirm('Force settle '+id+' mode='+mode+'?')) return; const farms=getStore('farms',[]); const idx=farms.findIndex(f=>f.id===id); if(idx===-1) return alert('Not found'); const f=farms[idx]; if(f.status!=='growing') return alert('Not in growing'); 
const cfgs = {
  tomato: { lotSize: 20, chance: 3, returnPerItem: 20, costPerLot: 200 },
  carrot: { lotSize: 15, chance: 4, returnPerItem: 18, costPerLot: 150 },
  potato: { lotSize: 25, chance: 2, returnPerItem: 25, costPerLot: 250 }
};


const cfg=cfgs[f.crop]||cfgs.tomato; let totalWins=0; let perLotWins=[]; if(mode==='win'){ for(let l=0;l<f.lots;l++){ perLotWins.push(cfg.lotSize); totalWins+=cfg.lotSize; } } else if(mode==='lose'){ for(let l=0;l<f.lots;l++){ perLotWins.push(0); } totalWins=0; } else { for(let l=0;l<f.lots;l++){ let lotWins=0; for(let i=0;i<cfg.lotSize;i++){ if(Math.random()*100<=cfg.chance) lotWins++; } perLotWins.push(lotWins); totalWins+=lotWins; } } const totalReturn = totalWins * cfg.returnPerItem;
 const profit = totalReturn - f.cost;
  f.status='finished';
  f.wins=totalWins;
  f.perLotWins=perLotWins; 
  f.profit=profit; 
  f.finishedAt=now(); 
  f.status='finished';
  farms[idx]=f; setStore('farms',farms); 
  if(firebaseEnabled && db) writeDoc('farms', f.id, f); const users=getStore('users',{}); if(!users[f.owner]){ addLog('force-settle-user-missing', f.id); renderFarms(); return alert('Owner missing'); } users[f.owner].balance = Number(users[f.owner].balance||0)+Number(totalReturn); users[f.owner].stats = users[f.owner].stats||{farms:0,wins:0,profit:0}; users[f.owner].stats.farms=(users[f.owner].stats.farms||0)+1; users[f.owner].stats.wins=(users[f.owner].stats.wins||0)+totalWins; users[f.owner].stats.profit=(users[f.owner].stats.profit||0)+profit; setStore('users',users); if(firebaseEnabled && db) writeUser(f.owner, users[f.owner]); addLog('force-settle', `${id} ${mode} profit:${profit}`); renderFarms(); renderUsers(); recalcAllStats(); alert(`Farm ${id} settled (${mode}). Profit: ${formatINR(profit)}`); }

/* LOGS */
function renderLogs(){ const logs=getStore('adminLogs',[]); const tbody=document.querySelector('#logsTbl tbody'); tbody.innerHTML=''; logs.forEach(l=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${fmtTime(l.t)}</td><td>${l.action}</td><td>${l.details||''}</td>`; tbody.appendChild(tr); }); }
function clearAllLogs(){ if(!confirm('Clear all logs?')) return; setStore('adminLogs',[]); addLog('clear-logs',''); renderLogs(); }

/* STATS */
function recalcAllStats(){ const users=getStore('users',{}); const deps=getStore('deposits',[]); const wds=getStore('withdraws',[]); const farms=getStore('farms',[]); document.getElementById('statUsers').innerText = Object.keys(users).length; const totalDep = deps.reduce((s,d)=>s+Number(d.amount||0),0); const totalWith = wds.reduce((s,d)=>s+Number(d.amount||0),0); document.getElementById('statDepos').innerText = formatINR(totalDep); document.getElementById('statWith').innerText = formatINR(totalWith); document.getElementById('statPendingDep').innerText = deps.filter(d=>d.status==='pending').length; document.getElementById('statPendingWith').innerText = wds.filter(w=>w.status==='pending').length; document.getElementById('statPendingFarms').innerText = farms.filter(f=>f.status==='growing').length; renderFarms(); renderDeposits(); renderWithdraws(); renderUsers(); }

/* ADMIN SETTINGS */
function loadAdminSettingsToUI(){ const s=getStore('adminSettings',{globalForceMode:'normal'}); document.getElementById('globalForceMode').value = s.globalForceMode||'normal'; }
function saveAdminSettings(){ const s=getStore('adminSettings',{}); s.globalForceMode=document.getElementById('globalForceMode').value; setStore('adminSettings',s); addLog('save-settings', JSON.stringify(s)); alert('Saved'); }
function resetAdminSettings(){ setStore('adminSettings',{globalForceMode:'normal'}); loadAdminSettingsToUI(); addLog('reset-settings',''); alert('Reset'); }
function changeAdminPassword(){ const np=document.getElementById('newAdminPass').value||''; if(!np||np.trim().length<4) return alert('Password min 4 chars'); localStorage.setItem('adminPassword', np.trim()); addLog('change-admin-pass',''); alert('Password updated'); document.getElementById('newAdminPass').value=''; }

/* EXPORT / BACKUP */
function exportCSV(key){ let arr=[]; if(key==='users') arr = Object.values(getStore('users',{})); else arr = getStore(key,[]); if(!arr||arr.length===0) return alert('No data to export: '+key); const headers = Array.from(new Set(arr.flatMap(Object.keys))); const rows = [headers.join(',')]; arr.forEach(obj=>{ const r = headers.map(h=>{ const v = obj[h] !== undefined && obj[h] !== null ? String(obj[h]).replace(/"/g,'""') : ''; return `"${v}"`; }); rows.push(r.join(',')); }); const csv = rows.join('\n'); const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`${key}_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); addLog('export-csv', key); }
function backupAll(){ ['users','deposits','withdraws','farms','adminLogs','adminSettings'].forEach(k=>exportCSV(k)); addLog('backup-all',''); }

/* MODAL helpers */
function showModal(html){ const modal=document.getElementById('modal'); document.getElementById('modalBox').innerHTML = html; modal.style.display='flex'; document.body.style.overflow='hidden'; }
function closeModal(){ const modal=document.getElementById('modal'); document.getElementById('modalBox').innerHTML=''; modal.style.display='none'; document.body.style.overflow=''; }
document.getElementById('modal').addEventListener('click', function(e){ if(e.target && e.target.id==='modal') closeModal(); });

function openUserDetail(uid){ const users=getStore('users',{}); const u=users[uid]; if(!u) return alert('User not found'); const html = `<h3>User ‚Äî ${u.id}</h3><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">\n  <div class="pill"><b>Name:</b> ${u.name||'‚Äî'}</div><div class="pill"><b>UID:</b> ${u.id}</div>\n  <div class="pill"><b>Balance:</b> ${formatINR(u.balance||0)}</div><div class="pill"><b>Coins:</b> ${u.coins||0}</div>\n  <div class="pill"><b>Farms:</b> ${u.stats?.farms||0}</div><div class="pill"><b>Wins:</b> ${u.stats?.wins||0}</div>\n  </div>\n  <div style="margin-top:12px;display:flex;gap:8px">\n    <button class="btn gold" onclick="resetPassword('${uid}')">Reset Pass</button>\n    <button class="btn" onclick="openAddBalanceModal('${uid}')">Adjust</button>\n    <button class="btn ghost" onclick="toggleSuspend('${uid}')">${u.suspended? 'Unsuspend':'Suspend'}</button>\n    <button class="btn" style="background:var(--danger);color:#111" onclick="deleteUser('${uid}')">Delete</button>\n    <div style="margin-left:auto"><button class="btn" onclick="closeModal()">Close</button></div>\n  </div>`; showModal(html); }

function resetPassword(uid){ const users=getStore('users',{}); if(!users[uid]) return alert('User not found'); const np = prompt('Enter new password for '+uid+':'); if(!np) return; users[uid].password = np; setStore('users',users); if(firebaseEnabled && db) writeUser(uid, users[uid]); addLog('reset-pass', uid); alert('Updated'); closeModal(); renderUsers(); }
function deleteUser(uid){ if(!confirm('Delete user '+uid+' permanently?')) return; const users=getStore('users',{}); if(!users[uid]) return alert('Not found'); delete users[uid]; setStore('users',users); if(firebaseEnabled && db) db.collection('users').doc(uid).delete().catch(()=>{}); addLog('delete-user', uid); alert('Deleted'); closeModal(); renderUsers(); recalcAllStats(); }

/* PURGE / DEV */
function purgeTestData(){ if(!confirm('Purge deposits, withdraws, farms? Users preserved')) return; setStore('deposits',[]); setStore('withdraws',[]); setStore('farms',[]); addLog('purge-data',''); renderDeposits(); renderWithdraws(); renderFarms(); recalcAllStats(); alert('Done'); }

/* Firestore helpers: read collections if available */
async function fetchFromFirestore(){
  if(!firebaseEnabled || !db) return Promise.reject(new Error('firebase-disabled'));
  const toFetch = ['users','deposits','withdraws','farms','adminLogs','adminSettings'];
  const results = {};
  for(const col of toFetch){
    try{
      const snap = await db.collection(col).get();
      if(col === 'users'){
        const map = {}; snap.forEach(doc => { map[doc.id] = Object.assign({id:doc.id}, doc.data()); }); results[col] = map;
      } else {
        const arr = []; snap.forEach(doc => { const d = doc.data(); d.id = doc.id; arr.push(d); }); results[col] = arr;
      }
    }catch(e){ console.warn('firestore read failed', col, e); throw e; }
  }
  // write into localStorage carefully (only if results present)
  if(results.users) setStore('users', results.users);
  if(results.deposits) setStore('deposits', results.deposits);
  if(results.withdraws) setStore('withdraws', results.withdraws);
  if(results.farms) setStore('farms', results.farms);
  if(results.adminLogs) setStore('adminLogs', results.adminLogs);
  if(results.adminSettings && results.adminSettings.length){ const as = results.adminSettings[0] || results.adminSettings; setStore('adminSettings', as); }
  return Promise.resolve(true);
}

/* Firestore write helpers (safe, best-effort) */
function writeDoc(col, id, data){ if(!firebaseEnabled || !db) return Promise.resolve(); try{ return db.collection(col).doc(String(id)).set(data); }catch(e){ console.warn(e); return Promise.resolve(); } }
function writeUser(uid, data){ if(!firebaseEnabled || !db) return Promise.resolve(); try{ return db.collection('users').doc(String(uid)).set(data); }catch(e){ console.warn(e); return Promise.resolve(); } }

/* ====== PRO REFRESH (R3) ====== */
let refreshTimeoutHandle = null;
function showLoader(){ document.getElementById('loaderWrap').style.display='flex'; }
function hideLoader(){ document.getElementById('loaderWrap').style.display='none'; }

async function softRefresh(){
  // re-render from localStorage immediately
  renderUsers(); renderDeposits(); renderWithdraws(); renderFarms(); renderLogs(); recalcAllStats();
  // if firebase enabled, attempt to fetch and overwrite localStorage
  if(firebaseEnabled && db){ await fetchFromFirestore(); renderUsers(); renderDeposits(); renderWithdraws(); renderFarms(); renderLogs(); recalcAllStats(); }
  return true;
}

function proRefresh(){ showLoader(); let fallback = false; refreshTimeoutHandle = setTimeout(()=>{ fallback = true; console.warn('Soft refresh timeout ‚Äî performing hard reload'); hideLoader(); location.reload(); }, 8000); softRefresh().then(()=>{ if(fallback) return; clearTimeout(refreshTimeoutHandle); hideLoader(); addLog('refresh','soft-success'); const b = document.getElementById('refreshBtn'); b.animate([{transform:'scale(1)'},{transform:'scale(1.06)'},{transform:'scale(1)'}],{duration:380}); }).catch(err=>{ console.error('soft refresh failed', err); clearTimeout(refreshTimeoutHandle); hideLoader(); location.reload(); }); }

/* HELP */
function openHelp(){ const html = `<h3>Admin Help</h3>\n    <div class="small muted">Shortcuts & notes:</div>\n    <ul>\n      <li>REFRESH uses Pro R3: soft refresh then hard reload fallback.</li>\n      <li>Backup regularly ‚Äî localStorage is browser-only unless Firebase is enabled.</li>\n      <li>Use CSV export to create backups before heavy operations.</li>\n      <li>Firebase must allow client reads/writes ‚Äî configure security rules for production.</li>\n    </ul>\n    <div style="margin-top:10px;display:flex;gap:8px"><button class="btn" onclick="closeModal()">Close</button></div>`; showModal(html); }

/* INITIALIZATION: keep login box visible until login */
(function init(){ /* nothing auto */ })();
</script>

</body>
</html>
